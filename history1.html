<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史记录 - MindCare</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
/* 基础CSS变量和通用样式 */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-tertiary: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --info-color: #3b82f6;
    --transition-normal: all 0.3s ease;
    --transition-slow: all 0.5s ease;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
    --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.15);
    --radius-sm: 0.25rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --radius-3xl: 2rem;
    --radius-full: 9999px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    line-height: 1.6;
    color: var(--gray-900);
    background: var(--gray-50);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
}

/* 导航栏样式 */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    transition: var(--transition-normal);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.nav-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary-color);
}

.nav-menu {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.nav-link {
    text-decoration: none;
    color: var(--gray-600);
    font-weight: 500;
    transition: var(--transition-normal);
    position: relative;
}

.nav-link:hover,
.nav-link.active {
    color: var(--primary-color);
}

.nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-color);
    border-radius: 1px;
}

.nav-toggle {
    display: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-600);
    background: none;
    border: none;
}

/* 按钮样式 */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-lg);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-normal);
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    position: relative;
    overflow: hidden;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
}

.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background: var(--gradient-secondary);
    color: var(--white);
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-success {
    background: var(--gradient-success);
    color: var(--white);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-warning {
    background: var(--gradient-warning);
    color: var(--white);
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: var(--white);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* 主要内容区域 */
.main-content {
    min-height: 100vh;
    padding-top: 80px;
    background: var(--gray-50);
}

/* 页面头部 */
.page-header {
    background: var(--gradient-primary);
    color: var(--white);
    padding: 3rem 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    background-size: 50px 50px;
    animation: float 30s linear infinite;
    opacity: 0.3;
}

@keyframes float {
    0% { transform: translateX(0) translateY(0); }
    100% { transform: translateX(-50px) translateY(-50px); }
}

.page-header-content {
    position: relative;
    z-index: 2;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 1rem;
}

.page-subtitle {
    font-size: 1.25rem;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto;
}

/* 历史记录容器 */
.history-container {
    padding: 4rem 0;
}

.history-content {
    max-width: 1000px;
    margin: 0 auto;
}

/* 统计卡片 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-100);
    transition: var(--transition-normal);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-2xl);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.stat-icon.primary {
    background: var(--gradient-primary);
    color: var(--white);
}

.stat-icon.success {
    background: var(--gradient-success);
    color: var(--white);
}

.stat-icon.warning {
    background: var(--gradient-warning);
    color: var(--white);
}

.stat-icon.secondary {
    background: var(--gradient-secondary);
    color: var(--white);
}

.stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--gray-600);
    font-weight: 500;
}

/* 过滤器和操作栏 */
.filter-bar {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-100);
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-size: 0.875rem;
    transition: var(--transition-normal);
    min-width: 150px;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-input {
    padding: 0.75rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-size: 0.875rem;
    transition: var(--transition-normal);
    min-width: 200px;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* 历史记录列表 */
.history-list {
    display: grid;
    gap: 1.5rem;
}

.history-item {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-100);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.history-item:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-2px);
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.history-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-600);
    font-size: 0.875rem;
}

.history-status {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.status-completed {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.status-incomplete {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.history-content-grid {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 2rem;
    align-items: start;
}

.history-details {
    display: grid;
    gap: 1rem;
}

.detail-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: var(--gray-600);
    font-weight: 500;
    font-size: 0.875rem;
}

.detail-value {
    color: var(--gray-900);
    font-weight: 600;
}

.score-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.score-low {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.score-medium {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.score-high {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
}

.history-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-width: 200px;
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--white);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-100);
}

.empty-icon {
    font-size: 4rem;
    color: var(--gray-300);
    margin-bottom: 1.5rem;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 1rem;
}

.empty-description {
    color: var(--gray-600);
    margin-bottom: 2rem;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

/* 加载状态 */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.loading-overlay.show {
    display: flex;
}

.loading-content {
    text-align: center;
    background: var(--white);
    padding: 3rem;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-2xl);
    max-width: 400px;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.loading-subtitle {
    font-size: 0.875rem;
    color: var(--gray-600);
}

/* 分页 */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 3rem;
}

.pagination-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--gray-200);
    background: var(--white);
    color: var(--gray-600);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-normal);
    font-weight: 500;
}

.pagination-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.pagination-btn.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: var(--white);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* 趋势图表 */
.trend-chart {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-100);
    margin-bottom: 2rem;
}

.chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
}

.chart-container {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-500);
    border: 2px dashed var(--gray-200);
    border-radius: var(--radius-lg);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .nav-menu {
        display: none;
    }
    
    .nav-toggle {
        display: block;
    }
    
    .main-content {
        padding-top: 70px;
    }
    
    .page-header {
        padding: 2rem 0;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .page-subtitle {
        font-size: 1rem;
    }
    
    .history-container {
        padding: 2rem 0;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .filter-group {
        justify-content: stretch;
        flex-direction: column;
    }
    
    .filter-select,
    .search-input {
        min-width: auto;
        width: 100%;
    }
    
    .history-content-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .history-actions {
        flex-direction: row;
        flex-wrap: wrap;
        min-width: auto;
    }
    
    .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 1rem;
    }
    
    .page-title {
        font-size: 1.75rem;
    }
    
    .history-item {
        padding: 1.5rem;
    }
    
    .btn {
        padding: 0.625rem 1.25rem;
        font-size: 0.75rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.625rem;
    }
}

/* 动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.history-item {
    animation: fadeInUp 0.6s ease-out;
}

.stat-card {
    animation: slideInRight 0.4s ease-out;
}

/* 特殊效果 */
.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-primary:hover::before {
    left: 100%;
}
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-brain"></i>
                <span>MindCare</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">主页</a>
                <a href="test.html" class="nav-link">开始测试</a>
                <a href="#" class="nav-link active">历史记录</a>
                <a href="#" class="nav-link" id="logoutLink">退出</a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="main-content">
        <!-- 页面头部 -->
        <section class="page-header">
            <div class="container">
                <div class="page-header-content">
                    <h1 class="page-title">历史记录</h1>
                    <p class="page-subtitle">
                        查看您的测试历史、分析趋势，并获取个性化的健康建议
                    </p>
                </div>
            </div>
        </section>

        <!-- 历史记录内容 -->
        <section class="history-container">
            <div class="container">
                <div class="history-content">
                    <!-- 统计卡片 -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="stat-value" id="totalTests">-</div>
                            <div class="stat-label">总测试次数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value" id="avgScore">-</div>
                            <div class="stat-label">平均得分</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="stat-value" id="lastTestDate">-</div>
                            <div class="stat-label">最近测试</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon secondary">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="stat-value" id="aiReports">-</div>
                            <div class="stat-label">AI建议报告</div>
                        </div>
                    </div>

                    <!-- 趋势图表 -->
                    <div class="trend-chart">
                        <div class="chart-header">
                            <h3 class="chart-title">测试得分趋势</h3>
                            <button class="btn btn-outline btn-sm" id="generateHistoricalReport">
                                <i class="fas fa-chart-bar"></i>
                                生成历史分析报告
                            </button>
                        </div>
                        <div class="chart-container" id="trendChart">
                            <span>趋势图表将在这里显示</span>
                        </div>
                    </div>

                    <!-- 过滤器和操作栏 -->
                    <div class="filter-bar">
                        <div class="filter-group">
                            <select class="filter-select" id="timeFilter">
                                <option value="all">全部时间</option>
                                <option value="week">最近一周</option>
                                <option value="month">最近一月</option>
                                <option value="quarter">最近三月</option>
                                <option value="year">最近一年</option>
                            </select>
                            <select class="filter-select" id="statusFilter">
                                <option value="all">全部状态</option>
                                <option value="completed">已完成</option>
                                <option value="incomplete">未完成</option>
                            </select>
                            <input type="text" class="search-input" id="searchInput" placeholder="搜索测试记录...">
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-outline btn-sm" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i>
                                刷新
                            </button>
                            <button class="btn btn-secondary btn-sm" id="exportBtn">
                                <i class="fas fa-download"></i>
                                导出数据
                            </button>
                        </div>
                    </div>

                    <!-- 历史记录列表 -->
                    <div class="history-list" id="historyList">
                        <!-- 历史记录项将通过JavaScript动态生成 -->
                    </div>

                    <!-- 分页 -->
                    <div class="pagination" id="pagination">
                        <!-- 分页按钮将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">正在加载...</div>
            <div class="loading-subtitle" id="loadingSubtitle">请稍候</div>
        </div>
    </div>

    <script>
// API配置
const API_BASE_URL = '/api';

// 工具函数库
const Utils = {
    // 格式化日期
    formatDate: function(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
            return '今天';
        } else if (diffDays === 2) {
            return '昨天';
        } else if (diffDays <= 7) {
            return `${diffDays}天前`;
        } else {
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    },

    // 格式化相对时间
    formatRelativeTime: function(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 30) {
            return `${diffDays}天前`;
        } else if (diffDays <= 365) {
            const months = Math.floor(diffDays / 30);
            return `${months}个月前`;
        } else {
            const years = Math.floor(diffDays / 365);
            return `${years}年前`;
        }
    },

    // 格式化测试得分
    formatScore: function(score, maxScore = 52) {
        const percentage = Math.round((score / maxScore) * 100);
        return {
            score,
            percentage,
            level: this.getScoreLevel(score, maxScore),
            color: this.getScoreColor(score, maxScore)
        };
    },

    // 获取得分等级
    getScoreLevel: function(score, maxScore = 52) {
        const percentage = (score / maxScore) * 100;
        if (percentage <= 25) return '良好';
        if (percentage <= 50) return '轻度';
        if (percentage <= 75) return '中度';
        return '重度';
    },

    // 获取得分颜色
    getScoreColor: function(score, maxScore = 52) {
        const percentage = (score / maxScore) * 100;
        if (percentage <= 25) return 'score-low';
        if (percentage <= 50) return 'score-medium';
        return 'score-high';
    },

    // 格式化完成时间
    formatCompletionTime: function(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}分${secs}秒`;
    },

    // 生成随机ID
    generateId: function(length = 8) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    },

    // 防抖函数
    debounce: function(func, delay) {
        let timeoutId;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(context, args), delay);
        };
    }
};

// API请求封装
const API = {
    // 基础请求方法
    async request(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const config = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            ...options
        };

        try {
            const response = await fetch(url, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || '请求失败');
            }
            
            return data;
        } catch (error) {
            console.error(`API请求失败 [${endpoint}]:`, error);
            throw error;
        }
    },

    // GET请求
    async get(endpoint) {
        return this.request(endpoint, { method: 'GET' });
    },

    // POST请求
    async post(endpoint, data) {
        return this.request(endpoint, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    },

    // 获取测试历史
    async getTestHistory(params = {}) {
        const queryString = new URLSearchParams(params).toString();
        const endpoint = `/test/history${queryString ? '?' + queryString : ''}`;
        return this.get(endpoint);
    },

    // 获取测试详情
    async getTestDetail(testId) {
        return this.get(`/test/${testId}/detail`);
    },

    // 获取用户统计
    async getUserStatistics() {
        return this.get('/user/statistics');
    },

    // 生成AI报告
    async generateAIReport(type = 'historical') {
        return this.post('/ai/report', { type });
    },

    // 获取AI报告列表
    async getAIReports(params = {}) {
        const queryString = new URLSearchParams(params).toString();
        const endpoint = `/ai/reports${queryString ? '?' + queryString : ''}`;
        return this.get(endpoint);
    },

    // 获取用户资料
    async getUserProfile() {
        return this.get('/user/profile');
    },

    // 用户登出
    async logout() {
        return this.post('/logout');
    }
};

// 消息提示组件
const Toast = {
    container: null,

    init: function() {
        if (!this.container) {
            this.container = document.createElement('div');
            this.container.id = 'toastContainer';
            this.container.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                z-index: 10001;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                pointer-events: none;
            `;
            document.body.appendChild(this.container);
        }
    },

    show: function(message, type = 'info', duration = 3000) {
        this.init();

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            padding: 1rem 1.5rem;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            min-width: 250px;
            font-weight: 500;
        `;

        // 设置不同类型的样式
        if (type === 'success') {
            toast.style.borderLeft = '4px solid var(--success-color)';
            toast.style.color = 'var(--success-color)';
        } else if (type === 'error') {
            toast.style.borderLeft = '4px solid var(--error-color)';
            toast.style.color = 'var(--error-color)';
        } else if (type === 'warning') {
            toast.style.borderLeft = '4px solid var(--warning-color)';
            toast.style.color = 'var(--warning-color)';
        } else {
            toast.style.borderLeft = '4px solid var(--primary-color)';
            toast.style.color = 'var(--primary-color)';
        }

        this.container.appendChild(toast);

        // 显示动画
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 10);

        // 自动隐藏
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (this.container.contains(toast)) {
                    this.container.removeChild(toast);
                }
            }, 300);
        }, duration);
    },

    success: function(message, duration) {
        this.show(message, 'success', duration);
    },

    error: function(message, duration) {
        this.show(message, 'error', duration);
    },

    warning: function(message, duration) {
        this.show(message, 'warning', duration);
    },

    info: function(message, duration) {
        this.show(message, 'info', duration);
    }
};

// 历史记录管理器
class HistoryManager {
    constructor() {
        this.historyData = [];
        this.filteredData = [];
        this.currentPage = 1;
        this.pageSize = 10;
        this.filters = {
            time: 'all',
            status: 'all',
            search: ''
        };
        this.isLoggedIn = false;
        this.userProfile = null;
        this.init();
    }

    async init() {
        try {
            // 检查登录状态
            await this.checkLoginStatus();
            
            if (!this.isLoggedIn) {
                this.showLoginPrompt();
                return;
            }

            // 设置事件监听器
            this.setupEventListeners();
            
            // 加载数据
            await this.loadData();
            
            console.log('历史记录页面初始化完成');
        } catch (error) {
            console.error('初始化失败:', error);
            Toast.error('页面加载失败，请刷新重试');
        }
    }

    // 检查登录状态
    async checkLoginStatus() {
        try {
            const profile = await API.getUserProfile();
            this.isLoggedIn = true;
            this.userProfile = profile.profile;
        } catch (error) {
            this.isLoggedIn = false;
            console.log('用户未登录');
        }
    }

    // 显示登录提示
    showLoginPrompt() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-user-lock"></i>
                </div>
                <h3 class="empty-title">请先登录</h3>
                <p class="empty-description">
                    您需要登录才能查看测试历史记录
                </p>
                <button class="btn btn-primary" onclick="window.location.href='login.html'">
                    <i class="fas fa-sign-in-alt"></i>
                    立即登录
                </button>
            </div>
        `;
    }

    // 设置事件监听器
    setupEventListeners() {
        // 过滤器
        document.getElementById('timeFilter').addEventListener('change', (e) => {
            this.filters.time = e.target.value;
            this.applyFilters();
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            this.filters.status = e.target.value;
            this.applyFilters();
        });

        // 搜索（防抖）
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', Utils.debounce((e) => {
            this.filters.search = e.target.value.trim();
            this.applyFilters();
        }, 300));

        // 按钮事件
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.loadData();
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            this.exportData();
        });

        document.getElementById('generateHistoricalReport').addEventListener('click', () => {
            this.generateHistoricalReport();
        });

        // 登出按钮
        document.getElementById('logoutLink').addEventListener('click', (e) => {
            e.preventDefault();
            this.logout();
        });

        // 移动端导航
        const navToggle = document.getElementById('navToggle');
        if (navToggle) {
            navToggle.addEventListener('click', () => {
                const navMenu = document.querySelector('.nav-menu');
                navMenu.classList.toggle('active');
            });
        }
    }

    // 加载数据
    async loadData() {
        this.showLoading('正在加载历史记录...', '请稍候');

        try {
            // 并行加载历史记录和统计数据
            const [historyResult, statsResult, aiReportsResult] = await Promise.all([
                API.getTestHistory({ limit: 100 }),
                API.getUserStatistics(),
                API.getAIReports({ limit: 50 }).catch(() => ({ success: true, reports: [] }))
            ]);

            if (historyResult.success) {
                this.historyData = historyResult.history || [];
                this.applyFilters();
            }

            if (statsResult.success) {
                this.updateStatistics(statsResult.statistics, aiReportsResult.reports || []);
            }

            this.hideLoading();
            
            if (this.historyData.length === 0) {
                this.showEmptyState();
            }

        } catch (error) {
            this.hideLoading();
            console.error('加载数据失败:', error);
            Toast.error('加载数据失败，请重试');
        }
    }

    // 更新统计信息
    updateStatistics(stats, aiReports) {
        document.getElementById('totalTests').textContent = stats.total_tests || 0;
        document.getElementById('avgScore').textContent = stats.average_score ? 
            Math.round(stats.average_score) : '-';
        document.getElementById('lastTestDate').textContent = stats.last_test_date ? 
            Utils.formatDate(stats.last_test_date) : '-';
        document.getElementById('aiReports').textContent = aiReports.length || 0;
    }

    // 应用过滤器
    applyFilters() {
        let filtered = [...this.historyData];

        // 时间过滤
        if (this.filters.time !== 'all') {
            const now = new Date();
            let startDate;

            switch (this.filters.time) {
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'quarter':
                    startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
            }

            if (startDate) {
                filtered = filtered.filter(item => 
                    new Date(item.test_date) >= startDate
                );
            }
        }

        // 状态过滤
        if (this.filters.status !== 'all') {
            filtered = filtered.filter(item => {
                const isCompleted = item.completion_status === 'completed' || 
                    (item.questions && Object.keys(item.questions).length >= 13);
                return this.filters.status === 'completed' ? isCompleted : !isCompleted;
            });
        }

        // 搜索过滤
        if (this.filters.search) {
            const searchTerm = this.filters.search.toLowerCase();
            filtered = filtered.filter(item => 
                item.test_id.toLowerCase().includes(searchTerm) ||
                Utils.formatDate(item.test_date).toLowerCase().includes(searchTerm) ||
                (item.severity && item.severity.toLowerCase().includes(searchTerm))
            );
        }

        this.filteredData = filtered;
        this.currentPage = 1;
        this.renderHistory();
        this.renderPagination();
    }

    // 渲染历史记录
    renderHistory() {
        const historyList = document.getElementById('historyList');
        
        if (this.filteredData.length === 0) {
            this.showEmptyState();
            return;
        }

        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = startIndex + this.pageSize;
        const pageData = this.filteredData.slice(startIndex, endIndex);

        historyList.innerHTML = pageData.map(item => this.renderHistoryItem(item)).join('');

        // 添加动画延迟
        const items = historyList.querySelectorAll('.history-item');
        items.forEach((item, index) => {
            item.style.animationDelay = `${index * 0.1}s`;
        });
    }

    // 渲染单个历史记录项
    renderHistoryItem(item) {
        const isCompleted = item.completion_status === 'completed' || 
            (item.questions && Object.keys(item.questions).length >= 13);
        
        const score = item.total_score || 0;
        const scoreInfo = Utils.formatScore(score);
        
        const completionTime = item.completion_time ? 
            Utils.formatCompletionTime(item.completion_time) : '-';

        return `
            <div class="history-item" data-test-id="${item.test_id}">
                <div class="history-header">
                    <div class="history-date">
                        <i class="fas fa-calendar"></i>
                        <span>${Utils.formatDate(item.test_date)}</span>
                        <span class="history-status ${isCompleted ? 'status-completed' : 'status-incomplete'}">
                            ${isCompleted ? '已完成' : '未完成'}
                        </span>
                    </div>
                </div>
                
                <div class="history-content-grid">
                    <div class="history-details">
                        <div class="detail-row">
                            <span class="detail-label">测试ID</span>
                            <span class="detail-value">${item.test_id.substring(0, 8)}...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">测试得分</span>
                            <span class="detail-value">
                                <span class="score-badge ${scoreInfo.color}">
                                    <i class="fas fa-chart-pie"></i>
                                    ${score}/52 (${scoreInfo.level})
                                </span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">完成时间</span>
                            <span class="detail-value">${completionTime}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">症状同现</span>
                            <span class="detail-value">${this.formatCoOccurrence(item.co_occurrence)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">影响程度</span>
                            <span class="detail-value">${this.formatSeverity(item.severity)}</span>
                        </div>
                    </div>
                    
                    <div class="history-actions">
                        <button class="btn btn-primary btn-sm" onclick="historyManager.viewDetail('${item.test_id}')">
                            <i class="fas fa-eye"></i>
                            查看详情
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="historyManager.generateSingleReport('${item.test_id}')">
                            <i class="fas fa-robot"></i>
                            AI分析
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="historyManager.compareWithPrevious('${item.test_id}')">
                            <i class="fas fa-balance-scale"></i>
                            对比分析
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="historyManager.downloadReport('${item.test_id}')">
                            <i class="fas fa-download"></i>
                            下载报告
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // 格式化症状同现
    formatCoOccurrence(value) {
        const mapping = {
            'yes': '是',
            'no': '否',
            'sometimes': '有时'
        };
        return mapping[value] || value || '-';
    }

    // 格式化影响程度
    formatSeverity(value) {
        const mapping = {
            'no': '无问题',
            'minor': '轻微问题',
            'moderate': '中等问题', 
            'serious': '严重问题'
        };
        return mapping[value] || value || '-';
    }

    // 显示空状态
    showEmptyState() {
        const historyList = document.getElementById('historyList');
        const hasFilters = this.filters.time !== 'all' || 
                          this.filters.status !== 'all' || 
                          this.filters.search !== '';

        historyList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-${hasFilters ? 'search' : 'clipboard-list'}"></i>
                </div>
                <h3 class="empty-title">
                    ${hasFilters ? '没有找到匹配的记录' : '暂无测试记录'}
                </h3>
                <p class="empty-description">
                    ${hasFilters ? 
                        '请尝试调整筛选条件或清除搜索关键词' : 
                        '您还没有进行过心理健康测试，立即开始您的第一次测试吧！'
                    }
                </p>
                ${hasFilters ? 
                    '<button class="btn btn-outline" onclick="historyManager.clearFilters()"><i class="fas fa-times"></i> 清除筛选</button>' :
                    '<button class="btn btn-primary" onclick="window.location.href=\'test.html\'"><i class="fas fa-plus"></i> 开始测试</button>'
                }
            </div>
        `;
    }

    // 清除筛选条件
    clearFilters() {
        this.filters = { time: 'all', status: 'all', search: '' };
        document.getElementById('timeFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('searchInput').value = '';
        this.applyFilters();
    }

    // 渲染分页
    renderPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(this.filteredData.length / this.pageSize);

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHTML = '';

        // 上一页按钮
        paginationHTML += `
            <button class="pagination-btn" ${this.currentPage === 1 ? 'disabled' : ''} 
                onclick="historyManager.goToPage(${this.currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </button>
        `;

        // 页码按钮
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `
                <button class="pagination-btn" onclick="historyManager.goToPage(1)">1</button>
            `;
            if (startPage > 2) {
                paginationHTML += `<span class="pagination-ellipsis">...</span>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" 
                    onclick="historyManager.goToPage(${i})">${i}</button>
            `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<span class="pagination-ellipsis">...</span>`;
            }
            paginationHTML += `
                <button class="pagination-btn" onclick="historyManager.goToPage(${totalPages})">${totalPages}</button>
            `;
        }

        // 下一页按钮
        paginationHTML += `
            <button class="pagination-btn" ${this.currentPage === totalPages ? 'disabled' : ''} 
                onclick="historyManager.goToPage(${this.currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </button>
        `;

        pagination.innerHTML = paginationHTML;
    }

    // 跳转到指定页面
    goToPage(page) {
        const totalPages = Math.ceil(this.filteredData.length / this.pageSize);
        if (page >= 1 && page <= totalPages) {
            this.currentPage = page;
            this.renderHistory();
            this.renderPagination();
            
            // 滚动到顶部
            document.querySelector('.history-list').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    }

    // 查看详情
    async viewDetail(testId) {
        try {
            this.showLoading('正在加载测试详情...', '请稍候');
            const result = await API.getTestDetail(testId);
            this.hideLoading();

            if (result.success) {
                this.showDetailModal(result.detail);
            } else {
                Toast.error('获取测试详情失败');
            }
        } catch (error) {
            this.hideLoading();
            console.error('获取详情失败:', error);
            Toast.error('获取测试详情失败，请重试');
        }
    }

    // 显示详情模态框
    showDetailModal(detail) {
        // 创建模态框
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 2rem;
        `;

        const questions = detail.questions || {};
        const questionCount = Object.keys(questions).length;
        const scoreInfo = Utils.formatScore(detail.total_score || 0);

        modal.innerHTML = `
            <div style="
                background: white;
                padding: 2rem;
                border-radius: 1rem;
                max-width: 800px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #1f2937; margin: 0;">测试详情</h2>
                    <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: grid; gap: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">测试时间</div>
                            <div style="font-weight: 600;">${Utils.formatDate(detail.test_date)}</div>
                        </div>
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">总得分</div>
                            <div style="font-weight: 600;">${detail.total_score || 0}/52 (${scoreInfo.level})</div>
                        </div>
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">完成问题</div>
                            <div style="font-weight: 600;">${questionCount}/13</div>
                        </div>
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">完成时间</div>
                            <div style="font-weight: 600;">${detail.completion_time ? Utils.formatCompletionTime(detail.completion_time) : '-'}</div>
                        </div>
                    </div>
                    
                    <div style="padding: 1.5rem; background: #f9fafb; border-radius: 0.75rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">问卷答案</h3>
                        <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
                            ${Object.entries(questions).map(([key, value]) => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                                    <span>${key}</span>
                                    <span style="font-weight: 600;">${this.formatAnswer(value)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="historyManager.generateSingleReport('${detail.test_id}')">
                            <i class="fas fa-robot"></i>
                            生成AI分析
                        </button>
                        <button class="btn btn-secondary" onclick="historyManager.downloadReport('${detail.test_id}')">
                            <i class="fas fa-download"></i>
                            下载报告
                        </button>
                        <button class="btn btn-outline" onclick="document.body.removeChild(this.closest('div').parentElement)">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // 格式化答案
    formatAnswer(value) {
        const mapping = {
            'no': '从未',
            'rarely': '很少',
            'sometimes': '有时',
            'often': '经常',
            'always': '总是',
            'yes': '是',
            'minor': '轻微',
            'moderate': '中等',
            'serious': '严重'
        };
        return mapping[value] || value || '-';
    }

    // 生成单个测试的AI报告
    async generateSingleReport(testId) {
        try {
            this.showLoading('正在生成AI分析报告...', '请稍候，这可能需要几秒钟');
            const result = await API.generateAIReport('single');
            this.hideLoading();

            if (result.success) {
                Toast.success('AI分析报告生成成功！');
                this.showReportModal(result.reports[0]);
            } else {
                Toast.error('生成AI报告失败');
            }
        } catch (error) {
            this.hideLoading();
            console.error('生成AI报告失败:', error);
            Toast.error('生成AI报告失败，请重试');
        }
    }

    // 生成历史分析报告
    async generateHistoricalReport() {
        if (this.historyData.length < 2) {
            Toast.warning('至少需要2次测试记录才能生成历史分析报告');
            return;
        }

        try {
            this.showLoading('正在生成历史分析报告...', '正在分析您的测试趋势和变化');
            const result = await API.generateAIReport('historical');
            this.hideLoading();

            if (result.success) {
                Toast.success('历史分析报告生成成功！');
                this.showReportModal(result.reports[0]);
            } else {
                Toast.error('生成历史分析报告失败');
            }
        } catch (error) {
            this.hideLoading();
            console.error('生成历史报告失败:', error);
            Toast.error('生成历史分析报告失败，请重试');
        }
    }

    // 显示报告模态框
    showReportModal(report) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 2rem;
        `;

        modal.innerHTML = `
            <div style="
                background: white;
                padding: 2rem;
                border-radius: 1rem;
                max-width: 900px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #1f2937; margin: 0;">历史分析报告</h2>
                    <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="line-height: 1.6; color: #374151;">
                    ${report.content || '报告内容生成中...'}
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="historyManager.downloadAIReport('${report.report_id}')">
                        <i class="fas fa-download"></i>
                        下载报告
                    </button>
                    <button class="btn btn-secondary" onclick="historyManager.shareReport('${report.report_id}')">
                        <i class="fas fa-share"></i>
                        分享报告
                    </button>
                    <button class="btn btn-outline" onclick="document.body.removeChild(this.closest('div').parentElement)">
                        关闭
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // 对比分析
    async compareWithPrevious(testId) {
        const currentIndex = this.historyData.findIndex(item => item.test_id === testId);
        if (currentIndex === -1 || currentIndex === this.historyData.length - 1) {
            Toast.warning('没有更早的测试记录进行对比');
            return;
        }

        const currentTest = this.historyData[currentIndex];
        const previousTest = this.historyData[currentIndex + 1];

        this.showComparisonModal(currentTest, previousTest);
    }

    // 显示对比模态框
    showComparisonModal(current, previous) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 2rem;
        `;

        const currentScore = current.total_score || 0;
        const previousScore = previous.total_score || 0;
        const scoreDiff = currentScore - previousScore;
        const diffColor = scoreDiff > 0 ? '#ef4444' : scoreDiff < 0 ? '#10b981' : '#6b7280';
        const diffIcon = scoreDiff > 0 ? 'fa-arrow-up' : scoreDiff < 0 ? 'fa-arrow-down' : 'fa-minus';

        modal.innerHTML = `
            <div style="
                background: white;
                padding: 2rem;
                border-radius: 1rem;
                max-width: 800px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #1f2937; margin: 0;">测试对比分析</h2>
                    <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: grid; gap: 2rem;">
                    <div style="text-align: center; padding: 1.5rem; background: #f9fafb; border-radius: 0.75rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">得分变化</h3>
                        <div style="font-size: 2rem; font-weight: 800; color: ${diffColor}; margin-bottom: 0.5rem;">
                            <i class="fas ${diffIcon}"></i>
                            ${Math.abs(scoreDiff)} 分
                        </div>
                        <div style="color: #6b7280;">
                            ${scoreDiff > 0 ? '得分上升' : scoreDiff < 0 ? '得分下降' : '得分无变化'}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div style="padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 0.75rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">当前测试</h4>
                            <div style="display: grid; gap: 0.75rem; font-size: 0.875rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>测试时间:</span>
                                    <span style="font-weight: 600;">${Utils.formatDate(current.test_date)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>总得分:</span>
                                    <span style="font-weight: 600;">${currentScore}/52</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>完成时间:</span>
                                    <span style="font-weight: 600;">${current.completion_time ? Utils.formatCompletionTime(current.completion_time) : '-'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 0.75rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #1f2937;">对比测试</h4>
                            <div style="display: grid; gap: 0.75rem; font-size: 0.875rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>测试时间:</span>
                                    <span style="font-weight: 600;">${Utils.formatDate(previous.test_date)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>总得分:</span>
                                    <span style="font-weight: 600;">${previousScore}/52</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>完成时间:</span>
                                    <span style="font-weight: 600;">${previous.completion_time ? Utils.formatCompletionTime(previous.completion_time) : '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 1.5rem; background: #f0f9ff; border-radius: 0.75rem; border-left: 4px solid #3b82f6;">
                        <h4 style="margin: 0 0 1rem 0; color: #1f2937;">分析建议</h4>
                        <p style="margin: 0; color: #374151; line-height: 1.6;">
                            ${this.generateComparisonAdvice(scoreDiff, currentScore)}
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="historyManager.generateComparisonReport('${current.test_id}', '${previous.test_id}')">
                            <i class="fas fa-robot"></i>
                            生成详细对比报告
                        </button>
                        <button class="btn btn-outline" onclick="document.body.removeChild(this.closest('div').parentElement)">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // 生成对比建议
    generateComparisonAdvice(scoreDiff, currentScore) {
        if (scoreDiff > 5) {
            return '您的测试得分有明显上升，这可能表明症状有所加重。建议您密切关注自己的情绪状态，如有需要请及时寻求专业帮助。';
        } else if (scoreDiff < -5) {
            return '恭喜！您的测试得分有明显下降，这表明您的心理状态有所改善。请继续保持良好的生活习惯和心理调节方式。';
        } else if (Math.abs(scoreDiff) <= 2) {
            return '您的测试得分基本保持稳定，这表明您的心理状态相对稳定。建议继续保持现有的生活方式和应对策略。';
        } else {
            return '您的测试得分有轻微变化，这可能是正常的波动。建议继续关注自己的心理健康状态。';
        }
    }

    // 生成对比报告
    async generateComparisonReport(currentId, previousId) {
        try {
            this.showLoading('正在生成对比分析报告...', '正在分析两次测试的差异');
            const result = await API.generateAIReport('comparison');
            this.hideLoading();

            if (result.success) {
                Toast.success('对比分析报告生成成功！');
                this.showReportModal(result.reports[0]);
            } else {
                Toast.error('生成对比报告失败');
            }
        } catch (error) {
            this.hideLoading();
            console.error('生成对比报告失败:', error);
            Toast.error('生成对比报告失败，请重试');
        }
    }

    // 下载报告
    downloadReport(testId) {
        // 这里实现下载逻辑
        Toast.info('下载功能开发中...');
    }

    // 下载AI报告
    downloadAIReport(reportId) {
        // 这里实现AI报告下载逻辑
        Toast.info('AI报告下载功能开发中...');
    }

    // 分享报告
    shareReport(reportId) {
        // 这里实现分享逻辑
        Toast.info('分享功能开发中...');
    }

    // 导出数据
    exportData() {
        if (this.historyData.length === 0) {
            Toast.warning('没有数据可以导出');
            return;
        }

        try {
            const data = this.historyData.map(item => ({
                '测试ID': item.test_id,
                '测试时间': item.test_date,
                '总得分': item.total_score || 0,
                '完成时间': item.completion_time ? Utils.formatCompletionTime(item.completion_time) : '-',
                '症状同现': this.formatCoOccurrence(item.co_occurrence),
                '影响程度': this.formatSeverity(item.severity),
                '完成状态': item.completion_status === 'completed' ? '已完成' : '未完成'
            }));

            const csv = this.convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `心理健康测试记录_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Toast.success('数据导出成功！');
            }
        } catch (error) {
            console.error('导出失败:', error);
            Toast.error('数据导出失败，请重试');
        }
    }

    // 转换为CSV格式
    convertToCSV(data) {
        if (data.length === 0) return '';

        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');

        return '\uFEFF' + csvContent; // 添加BOM以支持中文
    }

    // 用户登出
    async logout() {
        try {
            await API.logout();
            Toast.success('已成功退出登录');
            window.location.href = 'login.html';
        } catch (error) {
            console.error('登出失败:', error);
            Toast.error('登出失败，请重试');
        }
    }

    // 显示加载状态
    showLoading(text, subtitle) {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtitle = document.getElementById('loadingSubtitle');
        
        if (overlay) {
            overlay.classList.add('show');
            if (loadingText) loadingText.textContent = text;
            if (loadingSubtitle) loadingSubtitle.textContent = subtitle;
        }
    }

    // 隐藏加载状态
    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
    }
}

// 全局变量
let historyManager;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // 检查是否为移动设备
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            document.body.classList.add('mobile');
        }

        // 初始化历史记录管理器
        historyManager = new HistoryManager();
        
        console.log('历史记录页面加载完成');
        
    } catch (error) {
        console.error('页面初始化失败:', error);
        Toast.error('页面加载失败，请刷新重试');
    }
});

// 处理页面错误
window.addEventListener('error', (e) => {
    console.error('页面错误:', e.error);
    Toast.error('页面出现错误，请刷新重试');
});

// 处理未捕获的Promise拒绝
window.addEventListener('unhandledrejection', (e) => {
    console.error('未处理的Promise拒绝:', e.reason);
    Toast.error('网络请求失败，请检查网络连接');
});

// 性能监控
window.addEventListener('load', () => {
    const loadTime = performance.now();
    console.log(`页面加载时间: ${Math.round(loadTime)}ms`);
    
    if (loadTime > 3000) {
        Toast.info('页面加载较慢，建议检查网络连接');
    }
});
    </script>
</body>
</html>