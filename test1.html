<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心理健康测试 - MindCare</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
/* 基础CSS变量和通用样式 */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-tertiary: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --info-color: #3b82f6;
    --transition-normal: all 0.3s ease;
    --transition-slow: all 0.5s ease;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
    --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.15);
    --radius-sm: 0.25rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --radius-3xl: 2rem;
    --radius-full: 9999px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    line-height: 1.6;
    color: var(--gray-900);
    background: var(--gray-50);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
}

/* 导航栏样式 */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    transition: var(--transition-normal);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.nav-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary-color);
}

.nav-menu {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.nav-link {
    text-decoration: none;
    color: var(--gray-600);
    font-weight: 500;
    transition: var(--transition-normal);
    position: relative;
}

.nav-link:hover,
.nav-link.active {
    color: var(--primary-color);
}

.nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-color);
    border-radius: 1px;
}

.nav-toggle {
    display: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-600);
    background: none;
    border: none;
}

/* 按钮样式 */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    border-radius: var(--radius-lg);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-normal);
    border: none;
    cursor: pointer;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
}

.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-secondary {
    background: var(--gradient-secondary);
    color: var(--white);
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-success {
    background: var(--gradient-success);
    color: var(--white);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: var(--white);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* 测试页面主要样式 */
.test-main {
    min-height: 100vh;
    padding-top: 80px;
    background: var(--gray-50);
}

/* 页面头部 */
.test-header {
    background: var(--gradient-primary);
    color: var(--white);
    padding: 3rem 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.test-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    background-size: 50px 50px;
    animation: float 30s linear infinite;
    opacity: 0.3;
}

@keyframes float {
    0% { transform: translateX(0) translateY(0); }
    100% { transform: translateX(-50px) translateY(-50px); }
}

.test-header-content {
    position: relative;
    z-index: 2;
}

.test-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 1rem;
}

.test-subtitle {
    font-size: 1.25rem;
    opacity: 0.9;
    margin-bottom: 2rem;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.test-progress {
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-full);
    height: 8px;
    max-width: 600px;
    margin: 0 auto 1rem;
    overflow: hidden;
}

.progress-bar {
    background: var(--white);
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.5s ease;
    width: 0%;
}

.progress-text {
    font-size: 0.875rem;
    opacity: 0.9;
}

/* 测试容器 */
.test-container {
    padding: 4rem 0;
}

.test-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    max-width: 900px;
    margin: 0 auto;
}

/* 问卷部分 */
.questionnaire-section {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 3rem;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--gray-100);
}

.section-header {
    text-align: center;
    margin-bottom: 3rem;
}

.section-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.section-description {
    color: var(--gray-600);
    font-size: 1.125rem;
    max-width: 600px;
    margin: 0 auto;
}

/* 问题样式 */
.question-container {
    margin-bottom: 2.5rem;
    padding: 2rem;
    background: var(--gray-50);
    border-radius: var(--radius-xl);
    border: 1px solid var(--gray-100);
    transition: var(--transition-normal);
}

.question-container:hover {
    box-shadow: var(--shadow-md);
}

.question-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: var(--gradient-primary);
    color: var(--white);
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.question-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.question-options {
    display: grid;
    gap: 0.75rem;
}

.option-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: var(--transition-normal);
    position: relative;
}

.option-item:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.option-item.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

.option-item.selected::after {
    content: '✓';
    position: absolute;
    right: 1rem;
    color: var(--primary-color);
    font-weight: 700;
}

.option-radio {
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-radius: 50%;
    position: relative;
    flex-shrink: 0;
}

.option-item.selected .option-radio {
    border-color: var(--primary-color);
    background: var(--primary-color);
}

.option-item.selected .option-radio::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: var(--white);
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

.option-text {
    color: var(--gray-700);
    font-weight: 500;
}

.option-score {
    margin-left: auto;
    font-size: 0.875rem;
    color: var(--gray-500);
    font-weight: 600;
}

/* 脑部影像上传部分 */
.upload-section {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 3rem;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--gray-100);
    margin-top: 2rem;
}

.upload-container {
    max-width: 600px;
    margin: 0 auto;
}

.upload-area {
    border: 3px dashed var(--gray-300);
    border-radius: var(--radius-xl);
    padding: 3rem 2rem;
    text-align: center;
    background: var(--gray-50);
    transition: var(--transition-normal);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.upload-area.has-file {
    border-color: var(--success-color);
    background: rgba(16, 185, 129, 0.05);
}

.upload-icon {
    font-size: 3rem;
    color: var(--gray-400);
    margin-bottom: 1rem;
    transition: var(--transition-normal);
}

.upload-area:hover .upload-icon,
.upload-area.dragover .upload-icon {
    color: var(--primary-color);
    transform: scale(1.1);
}

.upload-area.has-file .upload-icon {
    color: var(--success-color);
}

.upload-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.upload-hint {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin-bottom: 1.5rem;
}

.upload-button {
    background: var(--gradient-primary);
    color: var(--white);
    padding: 0.75rem 2rem;
    border-radius: var(--radius-lg);
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-normal);
}

.upload-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.file-input {
    display: none;
}

.file-info {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.file-info.show {
    display: block;
}

.file-name {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.file-size {
    font-size: 0.875rem;
    color: var(--gray-500);
}

.remove-file {
    background: var(--error-color);
    color: var(--white);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: var(--transition-normal);
}

.remove-file:hover {
    background: #dc2626;
}

/* 支持的格式提示 */
.supported-formats {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.formats-title {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1rem;
}

.formats-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.format-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-600);
    font-size: 0.875rem;
}

.format-item i {
    color: var(--success-color);
}

/* 操作按钮区域 */
.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 3rem;
    padding: 2rem;
    background: var(--white);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-lg);
}

/* 测试完成状态 */
.completion-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.status-item.completed .status-icon {
    background: var(--success-color);
    color: var(--white);
}

.status-item.pending .status-icon {
    background: var(--gray-300);
    color: var(--gray-600);
}

.status-text {
    font-weight: 600;
    color: var(--gray-900);
}

/* 加载状态 */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.loading-overlay.show {
    display: flex;
}

.loading-content {
    text-align: center;
    background: var(--white);
    padding: 3rem;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-2xl);
    max-width: 400px;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.loading-subtitle {
    font-size: 0.875rem;
    color: var(--gray-600);
}

/* 额外的问卷字段 */
.additional-fields {
    margin-top: 3rem;
    padding: 2rem;
    background: var(--gray-50);
    border-radius: var(--radius-xl);
    border: 1px solid var(--gray-100);
}

.additional-fields h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1.5rem;
}

.field-group {
    margin-bottom: 1.5rem;
}

.field-label {
    display: block;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.field-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-size: 1rem;
    transition: var(--transition-normal);
}

.field-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.completion-time {
    background: var(--white);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    margin-top: 2rem;
    border: 1px solid var(--gray-200);
    text-align: center;
}

.time-display {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary-color);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .nav-menu {
        display: none;
    }
    
    .nav-toggle {
        display: block;
    }
    
    .test-main {
        padding-top: 70px;
    }
    
    .test-header {
        padding: 2rem 0;
    }
    
    .test-title {
        font-size: 2rem;
    }
    
    .test-subtitle {
        font-size: 1rem;
    }
    
    .questionnaire-section,
    .upload-section {
        padding: 2rem;
        margin: 1rem;
    }
    
    .question-container {
        padding: 1.5rem;
    }
    
    .option-item {
        padding: 0.75rem 1rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .completion-status {
        grid-template-columns: 1fr;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 1rem;
    }
    
    .test-title {
        font-size: 1.75rem;
    }
    
    .questionnaire-section,
    .upload-section {
        padding: 1.5rem;
        margin: 0.5rem;
    }
    
    .question-text {
        font-size: 1rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
    }
}

/* 动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.question-container {
    animation: fadeInUp 0.6s ease-out;
}

.option-item {
    animation: slideInRight 0.4s ease-out;
}

/* 特殊效果 */
.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-primary:hover::before {
    left: 100%;
}
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-brain"></i>
                <span>MindCare</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">主页</a>
                <a href="#" class="nav-link active">开始测试</a>
                <a href="history.html" class="nav-link">历史记录</a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="test-main">
        <!-- 测试头部 -->
        <section class="test-header">
            <div class="container">
                <div class="test-header-content">
                    <h1 class="test-title">心理健康评估测试</h1>
                    <p class="test-subtitle">
                        基于专业的心境障碍问卷（Mood Disorders Questionnaire），
                        结合脑部影像AI分析，为您提供全面的心理健康评估
                    </p>
                    <div class="test-progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p class="progress-text">
                        完成进度: <span id="progressText">0%</span>
                    </p>
                </div>
            </div>
        </section>

        <!-- 测试内容 -->
        <section class="test-container">
            <div class="container">
                <div class="test-content">
                    <!-- 问卷部分 -->
                    <div class="questionnaire-section">
                        <div class="section-header">
                            <h2 class="section-title">心境障碍问卷</h2>
                            <p class="section-description">
                                请仔细阅读每个问题，根据您的真实情况选择最符合的答案。
                                问卷采用专业的MDQ量表，有助于识别可能的心境障碍症状。
                            </p>
                        </div>

                        <form id="questionnaireForm">
                            <div id="questionsContainer">
                                <!-- 问题将通过JavaScript动态生成 -->
                            </div>

                            <!-- 额外字段 -->
                            <div class="additional-fields">
                                <h3>附加信息</h3>
                                <div class="field-group">
                                    <label for="coOccurrence" class="field-label">
                                        这些症状是否同时出现？
                                    </label>
                                    <select id="coOccurrence" class="field-select" name="co_occurrence">
                                        <option value="">请选择</option>
                                        <option value="yes">是的，通常同时出现</option>
                                        <option value="no">不是，通常分别出现</option>
                                        <option value="sometimes">有时同时出现</option>
                                    </select>
                                </div>
                                
                                <div class="field-group">
                                    <label for="severity" class="field-label">
                                        这些症状对您的影响程度如何？
                                    </label>
                                    <select id="severity" class="field-select" name="severity">
                                        <option value="">请选择</option>
                                        <option value="no">没有问题</option>
                                        <option value="minor">轻微问题</option>
                                        <option value="moderate">中等问题</option>
                                        <option value="serious">严重问题</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 完成时间显示 -->
                            <div class="completion-time">
                                <div class="time-display">
                                    完成时间: <span id="completionTime">00:00</span>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 脑部影像上传部分 -->
                    <div class="upload-section" id="uploadSection">
                        <div class="section-header">
                            <h2 class="section-title">脑部影像分析</h2>
                            <p class="section-description">
                                上传您的脑部影像文件，我们的AI系统将进行智能分析，
                                为您提供更准确的心理健康评估结果。
                            </p>
                        </div>

                        <div class="upload-container">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt" id="uploadIcon"></i>
                                </div>
                                <div class="upload-text" id="uploadText">
                                    点击上传或拖拽文件到此区域
                                </div>
                                <div class="upload-hint">
                                    支持 NII、JPG、PNG、DICOM 格式，文件大小不超过 50MB
                                </div>
                                <button type="button" class="upload-button" id="uploadButton">
                                    <i class="fas fa-plus"></i>
                                    选择文件
                                </button>
                                <input type="file" id="fileInput" class="file-input" accept=".nii,.nii.gz,.jpg,.jpeg,.png,.dcm,.dicom" multiple>
                            </div>

                            <div class="file-info" id="fileInfo">
                                <div class="file-name" id="fileName"></div>
                                <div class="file-size" id="fileSize"></div>
                                <button type="button" class="remove-file" id="removeFile">
                                    <i class="fas fa-trash"></i>
                                    移除文件
                                </button>
                            </div>

                            <div class="supported-formats">
                                <h4 class="formats-title">支持的文件格式：</h4>
                                <div class="formats-list">
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>NII / NII.GZ (神经影像)</span>
                                    </div>
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>DICOM (医学影像)</span>
                                    </div>
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>JPG / JPEG (图片)</span>
                                    </div>
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>PNG (图片)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 测试完成状态 -->
                    <div class="completion-status" id="completionStatus">
                        <div class="status-item" id="questionnaireStatus">
                            <div class="status-icon pending">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="status-text">问卷评估</div>
                        </div>
                        <div class="status-item" id="uploadStatus">
                            <div class="status-icon pending">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="status-text">影像上传</div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline" id="saveProgress">
                            <i class="fas fa-save"></i>
                            保存进度
                        </button>
                        <button type="button" class="btn btn-secondary" id="previewResults">
                            <i class="fas fa-eye"></i>
                            预览结果
                        </button>
                        <button type="button" class="btn btn-success" id="generateReport" disabled>
                            <i class="fas fa-file-alt"></i>
                            生成AI报告
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">正在处理...</div>
            <div class="loading-subtitle" id="loadingSubtitle">请稍候，不要关闭页面</div>
        </div>
    </div>

    <script>
// API配置
const API_BASE_URL = '/api';

// 工具函数库
const Utils = {
    // 节流函数
    throttle: function(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    },

    // 防抖函数
    debounce: function(func, delay) {
        let timeoutId;
        return function() {
            const args = arguments;
            const context = this;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(context, args), delay);
        }
    },

    // 格式化文件大小
    formatFileSize: function(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    // 生成随机ID
    generateId: function(length = 8) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    },

    // 获取当前时间戳
    getCurrentTimestamp: function() {
        return new Date().toISOString();
    },

    // 格式化时间
    formatTime: function(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
};

// API请求封装
const API = {
    // 基础请求方法
    async request(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const config = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include', // 包含cookies用于会话管理
            ...options
        };

        try {
            const response = await fetch(url, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || '请求失败');
            }
            
            return data;
        } catch (error) {
            console.error(`API请求失败 [${endpoint}]:`, error);
            throw error;
        }
    },

    // GET请求
    async get(endpoint) {
        return this.request(endpoint, { method: 'GET' });
    },

    // POST请求
    async post(endpoint, data) {
        return this.request(endpoint, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    },

    // 文件上传
    async uploadFiles(files) {
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('files', file);
        });

        const url = `${API_BASE_URL}/test/upload`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || '文件上传失败');
            }
            
            return data;
        } catch (error) {
            console.error('文件上传失败:', error);
            throw error;
        }
    },

    // 保存MDQ测试结果
    async saveMDQTest(testData) {
        return this.post('/test/mdq', testData);
    },

    // 获取测试历史
    async getTestHistory(limit = 10) {
        return this.get(`/test/history?limit=${limit}`);
    },

    // 获取用户资料
    async getUserProfile() {
        return this.get('/user/profile');
    },

    // 检查用户登录状态
    async checkLoginStatus() {
        try {
            const profile = await this.getUserProfile();
            return { loggedIn: true, profile };
        } catch (error) {
            return { loggedIn: false, error: error.message };
        }
    }
};

// 消息提示组件
const Toast = {
    container: null,

    init: function() {
        if (!this.container) {
            this.container = document.createElement('div');
            this.container.id = 'toastContainer';
            this.container.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                z-index: 10001;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                pointer-events: none;
            `;
            document.body.appendChild(this.container);
        }
    },

    show: function(message, type = 'info', duration = 3000) {
        this.init();

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            padding: 1rem 1.5rem;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            min-width: 250px;
            font-weight: 500;
        `;

        // 设置不同类型的样式
        if (type === 'success') {
            toast.style.borderLeft = '4px solid var(--success-color)';
            toast.style.color = 'var(--success-color)';
        } else if (type === 'error') {
            toast.style.borderLeft = '4px solid var(--error-color)';
            toast.style.color = 'var(--error-color)';
        } else if (type === 'warning') {
            toast.style.borderLeft = '4px solid var(--warning-color)';
            toast.style.color = 'var(--warning-color)';
        } else {
            toast.style.borderLeft = '4px solid var(--primary-color)';
            toast.style.color = 'var(--primary-color)';
        }

        this.container.appendChild(toast);

        // 显示动画
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 10);

        // 自动隐藏
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (this.container.contains(toast)) {
                    this.container.removeChild(toast);
                }
            }, 300);
        }, duration);
    },

    success: function(message, duration) {
        this.show(message, 'success', duration);
    },

    error: function(message, duration) {
        this.show(message, 'error', duration);
    },

    warning: function(message, duration) {
        this.show(message, 'warning', duration);
    },

    info: function(message, duration) {
        this.show(message, 'info', duration);
    }
};

// MDQ问卷数据
const MDQQuestions = [
    {
        id: 1,
        text: "您是否曾经有过一段时间感到情绪特别高涨、兴奋或过度活跃？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 2,
        text: "在这种状态下，您是否感到比平时更加自信或自负？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 3,
        text: "您是否曾经睡眠需求明显减少，但仍感到精力充沛？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 4,
        text: "您是否比平时更加健谈或说话速度更快？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 5,
        text: "您的思维是否曾经快速跳跃，难以集中注意力？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 6,
        text: "您是否曾经特别容易分心，注意力难以持续？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 7,
        text: "您是否感到比平时更有活力和积极性？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 8,
        text: "您是否曾经比平时更爱社交或更外向？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 9,
        text: "您是否曾经对性的兴趣比平时更强烈？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 10,
        text: "您是否曾经做出一些不寻常或冲动的决定？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 11,
        text: "您是否曾经花钱比平时更冲动或不理智？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 12,
        text: "这些行为变化是否对您的工作、学习或人际关系造成了困扰？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    },
    {
        id: 13,
        text: "家人、朋友或医生是否注意到您的这些行为变化？",
        options: [
            { text: "从未", value: "no" },
            { text: "很少", value: "rarely" },
            { text: "有时", value: "sometimes" },
            { text: "经常", value: "often" },
            { text: "总是", value: "always" }
        ]
    }
];

// 测试管理器
class TestManager {
    constructor() {
        this.answers = {};
        this.uploadedFiles = [];
        this.currentProgress = 0;
        this.isQuestionnaireComplete = false;
        this.isUploadComplete = false;
        this.startTime = Date.now();
        this.timeInterval = null;
        this.isLoggedIn = false;
        this.userProfile = null;
        this.init();
    }

    async init() {
        // 检查登录状态
        await this.checkLoginStatus();
        
        this.renderQuestions();
        this.setupEventListeners();
        this.setupFileUpload();
        this.startTimer();
        this.updateProgress();
        this.loadSavedProgress();
    }

    // 检查登录状态
    async checkLoginStatus() {
        try {
            const status = await API.checkLoginStatus();
            this.isLoggedIn = status.loggedIn;
            this.userProfile = status.profile;
            
            if (!this.isLoggedIn) {
                Toast.warning('请先登录以保存测试结果', 5000);
                // 可以选择重定向到登录页面
                // window.location.href = 'login.html';
            } else {
                Toast.success(`欢迎，${this.userProfile.username}！`, 2000);
            }
        } catch (error) {
            console.error('检查登录状态失败:', error);
            Toast.error('无法验证登录状态');
        }
    }

    // 开始计时器
    startTimer() {
        this.timeInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            const timeDisplay = document.getElementById('completionTime');
            if (timeDisplay) {
                timeDisplay.textContent = Utils.formatTime(elapsed);
            }
        }, 1000);
    }

    // 停止计时器
    stopTimer() {
        if (this.timeInterval) {
            clearInterval(this.timeInterval);
            this.timeInterval = null;
        }
    }

    // 获取完成时间（秒）
    getCompletionTime() {
        return Math.floor((Date.now() - this.startTime) / 1000);
    }

    // 渲染问题
    renderQuestions() {
        const container = document.getElementById('questionsContainer');
        if (!container) return;

        container.innerHTML = MDQQuestions.map((question, index) => `
            <div class="question-container" data-question-id="${question.id}">
                <div class="question-number">${question.id}</div>
                <div class="question-text">${question.text}</div>
                <div class="question-options">
                    ${question.options.map((option, optionIndex) => `
                        <div class="option-item" data-value="${option.value}" data-question="${question.id}">
                            <div class="option-radio"></div>
                            <div class="option-text">${option.text}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');

        // 添加动画延迟
        const questions = container.querySelectorAll('.question-container');
        questions.forEach((question, index) => {
            question.style.animationDelay = `${index * 0.1}s`;
        });
    }

    // 设置事件监听器
    setupEventListeners() {
        // 问卷选项点击
        document.addEventListener('click', (e) => {
            if (e.target.closest('.option-item')) {
                this.handleOptionClick(e.target.closest('.option-item'));
            }
        });

        // 按钮事件
        document.getElementById('saveProgress')?.addEventListener('click', () => {
            this.saveProgress();
        });

        document.getElementById('previewResults')?.addEventListener('click', () => {
            this.previewResults();
        });

        document.getElementById('generateReport')?.addEventListener('click', () => {
            this.generateAndViewReport();
        });

        // 移动端导航
        const navToggle = document.getElementById('navToggle');
        if (navToggle) {
            navToggle.addEventListener('click', () => {
                const navMenu = document.querySelector('.nav-menu');
                navMenu.classList.toggle('active');
            });
        }
    }

    // 处理选项点击
    handleOptionClick(optionElement) {
        const questionId = parseInt(optionElement.dataset.question);
        const value = optionElement.dataset.value;

        // 移除同组其他选项的选中状态
        const questionContainer = optionElement.closest('.question-container');
        questionContainer.querySelectorAll('.option-item').forEach(item => {
            item.classList.remove('selected');
        });

        // 设置当前选项为选中状态
        optionElement.classList.add('selected');

        // 保存答案
        this.answers[`q${questionId}`] = value;

        // 添加选择动画
        optionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            optionElement.style.transform = '';
        }, 150);

        // 更新进度
        this.updateProgress();

        Toast.success(`问题 ${questionId} 已选择`, 1000);
    }

    // 设置文件上传
    setupFileUpload() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const removeButton = document.getElementById('removeFile');

        // 点击上传区域
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // 点击上传按钮
        uploadButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        // 文件选择
        fileInput.addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files);
        });

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            this.handleFileSelect(e.dataTransfer.files);
        });

        // 移除文件
        removeButton.addEventListener('click', () => {
            this.removeFiles();
        });
    }

    // 处理文件选择
    handleFileSelect(files) {
        if (files.length === 0) return;

        const validFiles = [];
        const maxSize = 50 * 1024 * 1024; // 50MB
        const validExtensions = ['.nii', '.nii.gz', '.jpg', '.jpeg', '.png', '.dcm', '.dicom'];

        Array.from(files).forEach(file => {
            // 检查文件大小
            if (file.size > maxSize) {
                Toast.error(`文件 ${file.name} 超过50MB限制`);
                return;
            }

            // 检查文件类型
            const fileName = file.name.toLowerCase();
            const isValidType = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isValidType) {
                Toast.error(`文件 ${file.name} 格式不支持`);
                return;
            }

            validFiles.push(file);
        });

        if (validFiles.length > 0) {
            this.uploadedFiles = validFiles;
            this.updateFileDisplay();
            this.updateProgress();
            Toast.success(`成功选择 ${validFiles.length} 个文件`);
        }
    }

    // 更新文件显示
    updateFileDisplay() {
        const uploadArea = document.getElementById('uploadArea');
        const uploadIcon = document.getElementById('uploadIcon');
        const uploadText = document.getElementById('uploadText');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        if (this.uploadedFiles.length > 0) {
            uploadArea.classList.add('has-file');
            uploadIcon.className = 'fas fa-check-circle';
            
            if (this.uploadedFiles.length === 1) {
                const file = this.uploadedFiles[0];
                uploadText.textContent = '文件上传成功';
                fileName.textContent = file.name;
                fileSize.textContent = Utils.formatFileSize(file.size);
            } else {
                uploadText.textContent = '多个文件上传成功';
                fileName.textContent = `${this.uploadedFiles.length} 个文件`;
                const totalSize = this.uploadedFiles.reduce((sum, file) => sum + file.size, 0);
                fileSize.textContent = Utils.formatFileSize(totalSize);
            }
            
            fileInfo.classList.add('show');
        } else {
            uploadArea.classList.remove('has-file');
            uploadIcon.className = 'fas fa-cloud-upload-alt';
            uploadText.textContent = '点击上传或拖拽文件到此区域';
            fileInfo.classList.remove('show');
        }
    }

    // 移除文件
    removeFiles() {
        this.uploadedFiles = [];
        this.updateFileDisplay();
        this.updateProgress();
        document.getElementById('fileInput').value = '';
        Toast.info('已移除所有文件');
    }

    // 更新进度
    updateProgress() {
        const totalQuestions = MDQQuestions.length;
        const answeredQuestions = Object.keys(this.answers).length;
        const questionnaireProgress = (answeredQuestions / totalQuestions) * 70; // 问卷占70%
        const uploadProgress = this.uploadedFiles.length > 0 ? 30 : 0; // 上传占30%
        
        this.currentProgress = questionnaireProgress + uploadProgress;
        this.isQuestionnaireComplete = answeredQuestions === totalQuestions;
        this.isUploadComplete = this.uploadedFiles.length > 0;

        // 更新进度条
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        if (progressBar) {
            progressBar.style.width = `${this.currentProgress}%`;
        }
        
        if (progressText) {
            progressText.textContent = `${Math.round(this.currentProgress)}%`;
        }

        // 更新状态指示器
        this.updateStatusIndicators();

        // 更新生成报告按钮状态
        this.updateGenerateButton();
    }

    // 更新状态指示器
    updateStatusIndicators() {
        const questionnaireStatus = document.getElementById('questionnaireStatus');
        const uploadStatus = document.getElementById('uploadStatus');

        if (questionnaireStatus) {
            const icon = questionnaireStatus.querySelector('.status-icon');
            if (this.isQuestionnaireComplete) {
                icon.classList.remove('pending');
                icon.classList.add('completed');
            } else {
                icon.classList.remove('completed');
                icon.classList.add('pending');
            }
        }

        if (uploadStatus) {
            const icon = uploadStatus.querySelector('.status-icon');
            if (this.isUploadComplete) {
                icon.classList.remove('pending');
                icon.classList.add('completed');
            } else {
                icon.classList.remove('completed');
                icon.classList.add('pending');
            }
        }
    }

    // 更新生成报告按钮
    updateGenerateButton() {
        const generateButton = document.getElementById('generateReport');
        if (generateButton) {
            const isComplete = this.isQuestionnaireComplete || this.isUploadComplete;
            generateButton.disabled = !isComplete;
            
            if (isComplete) {
                generateButton.style.opacity = '1';
                generateButton.style.cursor = 'pointer';
            } else {
                generateButton.style.opacity = '0.6';
                generateButton.style.cursor = 'not-allowed';
            }
        }
    }

    // 保存进度到localStorage
    saveProgress() {
        if (!this.isLoggedIn) {
            Toast.warning('请先登录以保存进度到服务器');
        }
        
        const progressData = {
            answers: this.answers,
            uploadedFileNames: this.uploadedFiles.map(f => f.name),
            additionalFields: this.getAdditionalFields(),
            timestamp: Utils.getCurrentTimestamp(),
            progress: this.currentProgress,
            completionTime: this.getCompletionTime()
        };

        try {
            // 保存到本地存储
            localStorage.setItem('testProgress', JSON.stringify(progressData));
            Toast.success('进度已保存到本地');
            
            // 如果已登录，同时保存到服务器
            if (this.isLoggedIn) {
                this.saveProgressToServer(progressData);
            }
        } catch (error) {
            console.error('保存进度失败:', error);
            Toast.error('保存失败，请重试');
        }
    }

    // 保存进度到服务器
    async saveProgressToServer(progressData) {
        try {
            // 这里可以添加保存进度到服务器的API调用
            // const result = await API.post('/test/save-progress', progressData);
            // Toast.success('进度已同步到服务器');
            console.log('进度数据准备保存到服务器:', progressData);
        } catch (error) {
            console.error('保存进度到服务器失败:', error);
            Toast.warning('无法同步到服务器，已保存到本地');
        }
    }

    // 获取附加字段的值
    getAdditionalFields() {
        return {
            co_occurrence: document.getElementById('coOccurrence')?.value || '',
            severity: document.getElementById('severity')?.value || ''
        };
    }

    // 加载保存的进度
    loadSavedProgress() {
        try {
            const savedData = localStorage.getItem('testProgress');
            if (savedData) {
                const progressData = JSON.parse(savedData);
                this.answers = progressData.answers || {};
                
                // 恢复附加字段
                if (progressData.additionalFields) {
                    const { co_occurrence, severity } = progressData.additionalFields;
                    if (co_occurrence) {
                        const coSelect = document.getElementById('coOccurrence');
                        if (coSelect) coSelect.value = co_occurrence;
                    }
                    if (severity) {
                        const severitySelect = document.getElementById('severity');
                        if (severitySelect) severitySelect.value = severity;
                    }
                }
                
                // 恢复问卷选择状态
                Object.entries(this.answers).forEach(([questionKey, value]) => {
                    const questionId = questionKey.replace('q', '');
                    const optionElement = document.querySelector(
                        `.option-item[data-question="${questionId}"][data-value="${value}"]`
                    );
                    if (optionElement) {
                        optionElement.classList.add('selected');
                    }
                });

                this.updateProgress();
                
                if (Object.keys(this.answers).length > 0) {
                    Toast.info('已恢复之前的测试进度');
                }
            }
        } catch (error) {
            console.error('加载进度失败:', error);
        }
    }

    // 预览结果
    previewResults() {
        if (Object.keys(this.answers).length === 0 && this.uploadedFiles.length === 0) {
            Toast.warning('请先完成问卷或上传脑部影像');
            return;
        }

        this.showLoading('正在分析数据...', '生成预览结果');

        // 模拟分析过程
        setTimeout(() => {
            this.hideLoading();
            
            const answeredQuestions = Object.keys(this.answers).length;
            const totalQuestions = MDQQuestions.length;
            const completionPercentage = Math.round((answeredQuestions / totalQuestions) * 100);

            let resultMessage = '';
            if (answeredQuestions === 0) {
                resultMessage = '请完成问卷以获得更准确的评估结果。';
            } else if (answeredQuestions < totalQuestions) {
                resultMessage = `已完成 ${answeredQuestions}/${totalQuestions} 个问题 (${completionPercentage}%)。建议完成所有问题以获得更准确的评估。`;
            } else {
                // 简单的评分逻辑（实际应用中应该更复杂）
                const positiveAnswers = Object.values(this.answers).filter(
                    answer => ['often', 'always', 'sometimes'].includes(answer)
                ).length;
                
                if (positiveAnswers <= 4) {
                    resultMessage = '初步评估显示心境状态良好，请继续保持健康的生活方式。';
                } else if (positiveAnswers <= 8) {
                    resultMessage = '初步评估显示可能存在轻度心境波动，建议关注心理健康。';
                } else if (positiveAnswers <= 10) {
                    resultMessage = '初步评估显示可能存在中度心境问题，建议寻求专业建议。';
                } else {
                    resultMessage = '初步评估显示可能存在较严重的心境问题，强烈建议咨询专业医生。';
                }
            }

            const uploadMessage = this.uploadedFiles.length > 0 
                ? `已上传 ${this.uploadedFiles.length} 个脑部影像文件。` 
                : '未上传脑部影像文件。';

            Toast.success(`预览结果：${resultMessage} ${uploadMessage}`, 8000);
        }, 2000);
    }

    // 生成并查看报告（简化版，直接跳转）
    async generateAndViewReport() {
        if (!this.isQuestionnaireComplete && !this.isUploadComplete) {
            Toast.warning('请至少完成问卷评估或上传脑部影像');
            return;
        }

        if (!this.isLoggedIn) {
            Toast.error('请先登录以保存测试结果');
            return;
        }

        this.showLoading('正在保存测试结果...', '准备生成AI分析报告');

        try {
            // 停止计时器
            this.stopTimer();
            const completionTime = this.getCompletionTime();

            // 准备要保存的测试数据
            const testData = {
                answers: this.answers,
                co_occurrence: document.getElementById('coOccurrence')?.value || 'no',
                severity: document.getElementById('severity')?.value || 'no',
                completion_time: completionTime
            };

            // 保存MDQ测试结果到数据库
            console.log('准备保存测试数据:', testData);
            const result = await API.saveMDQTest(testData);

            if (result.success) {
                Toast.success('测试结果已保存，正在跳转到AI报告页面...');
                
                // 保存完整的测试数据到本地缓存
                const fullTestData = {
                    testId: result.test_id,
                    timestamp: Utils.getCurrentTimestamp(),
                    answers: this.answers,
                    additionalFields: this.getAdditionalFields(),
                    uploadedFiles: this.uploadedFiles.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    })),
                    completionTime: completionTime,
                    analysis: result.analysis || null,
                    serverSaved: true
                };

                // 保存到历史记录
                this.saveToHistory(fullTestData);

                // 清除进度缓存
                localStorage.removeItem('testProgress');

                this.hideLoading();

                // 直接跳转到报告页面
                const reportUrl = `report.html?testId=${result.test_id}${result.analysis_id ? '&analysisId=' + result.analysis_id : ''}`;
                window.location.href = reportUrl;

            } else {
                throw new Error(result.message || '保存失败');
            }

        } catch (error) {
            this.hideLoading();
            console.error('保存测试结果失败:', error);
            
            if (error.message.includes('请先登录')) {
                Toast.error('会话已过期，请重新登录');
            } else {
                Toast.error(`保存失败：${error.message}`);
                
                // 提供本地保存选项
                this.offerLocalSave();
            }
        }
    }

    // 上传文件到服务器
    async uploadFilesToServer() {
        if (this.uploadedFiles.length === 0) {
            return { success: true, message: '没有文件需要上传' };
        }

        if (!this.isLoggedIn) {
            throw new Error('请先登录以上传文件');
        }

        try {
            const result = await API.uploadFiles(this.uploadedFiles);
            Toast.success(`成功上传 ${this.uploadedFiles.length} 个文件`);
            return result;
        } catch (error) {
            console.error('文件上传失败:', error);
            Toast.error(`文件上传失败：${error.message}`);
            throw error;
        }
    }

    // 保存到本地历史记录
    saveToHistory(testData) {
        try {
            const existingHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');
            existingHistory.unshift(testData);
            
            // 只保留最近10次测试
            if (existingHistory.length > 10) {
                existingHistory.splice(10);
            }
            
            localStorage.setItem('testHistory', JSON.stringify(existingHistory));
            console.log('测试结果已保存到本地历史记录');
        } catch (error) {
            console.error('保存到本地历史记录失败:', error);
        }
    }

    // 提供本地保存选项
    offerLocalSave() {
        const testData = {
            id: Utils.generateId(12),
            timestamp: Utils.getCurrentTimestamp(),
            answers: this.answers,
            additionalFields: this.getAdditionalFields(),
            uploadedFiles: this.uploadedFiles.map(file => ({
                name: file.name,
                size: file.size,
                type: file.type
            })),
            completionTime: this.getCompletionTime(),
            serverSaved: false
        };

        this.saveToHistory(testData);
        
        Toast.warning('已保存到本地，稍后可重新尝试上传到服务器', 5000);
    }

    // 显示加载状态
    showLoading(text, subtitle) {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtitle = document.getElementById('loadingSubtitle');
        
        if (overlay) {
            overlay.classList.add('show');
            if (loadingText) loadingText.textContent = text;
            if (loadingSubtitle) loadingSubtitle.textContent = subtitle;
        }
    }

    // 隐藏加载状态
    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
    }

    // 验证问卷完整性
    validateQuestionnaire() {
        const requiredFields = [
            { id: 'coOccurrence', name: '症状同时出现' },
            { id: 'severity', name: '影响程度' }
        ];

        for (const field of requiredFields) {
            const element = document.getElementById(field.id);
            if (!element || !element.value) {
                Toast.warning(`请选择"${field.name}"`);
                element?.focus();
                return false;
            }
        }

        return true;
    }

    // 清理资源
    cleanup() {
        this.stopTimer();
        
        // 清除事件监听器
        window.removeEventListener('beforeunload', this.beforeUnloadHandler);
    }

    // 页面卸载前的处理
    beforeUnloadHandler = (e) => {
        if (Object.keys(this.answers).length > 0 || this.uploadedFiles.length > 0) {
            e.preventDefault();
            e.returnValue = '您的测试进度可能会丢失，确定要离开吗？';
            
            // 自动保存进度
            this.saveProgress();
        }
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // 检查是否为移动设备
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            document.body.classList.add('mobile');
        }

        // 初始化测试管理器
        const testManager = new TestManager();
        
        // 将实例绑定到全局，方便调试
        window.testManager = testManager;
        
        // 添加页面卸载时的提醒
        window.addEventListener('beforeunload', testManager.beforeUnloadHandler);
        
        // 添加页面可见性变化监听（用户切换标签页时自动保存）
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && testManager) {
                testManager.saveProgress();
            }
        });

        console.log('测试页面初始化完成');
        
    } catch (error) {
        console.error('测试页面初始化失败:', error);
        Toast.error('页面初始化失败，请刷新重试');
    }
});

// 处理页面错误
window.addEventListener('error', (e) => {
    console.error('页面错误:', e.error);
    Toast.error('页面出现错误，请刷新重试');
});

// 处理未捕获的Promise拒绝
window.addEventListener('unhandledrejection', (e) => {
    console.error('未处理的Promise拒绝:', e.reason);
    Toast.error('网络请求失败，请检查网络连接');
});

// 性能监控
window.addEventListener('load', () => {
    const loadTime = performance.now();
    console.log(`页面加载时间: ${Math.round(loadTime)}ms`);
    
    // 如果加载时间过长，给出提示
    if (loadTime > 3000) {
        Toast.info('页面加载较慢，建议检查网络连接');
    }
});

// 添加键盘快捷键支持
document.addEventListener('keydown', (e) => {
    // Ctrl+S 保存进度
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if (window.testManager) {
            window.testManager.saveProgress();
        }
    }
    
    // Ctrl+Enter 生成报告
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        if (window.testManager) {
            window.testManager.generateAndViewReport();
        }
    }
});
    </script>
</body>
</html>