<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Assessment - MindCare</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
/* 基础CSS变量和通用样式 */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-tertiary: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --info-color: #3b82f6;
    --transition-normal: all 0.3s ease;
    --transition-slow: all 0.5s ease;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
    --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.15);
    --radius-sm: 0.25rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --radius-3xl: 2rem;
    --radius-full: 9999px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    line-height: 1.6;
    color: var(--gray-900);
    background: var(--gray-50);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
}

/* 导航栏样式 */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    transition: var(--transition-normal);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.nav-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary-color);
}

.nav-menu {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.nav-link {
    text-decoration: none;
    color: var(--gray-600);
    font-weight: 500;
    transition: var(--transition-normal);
    position: relative;
}

.nav-link:hover,
.nav-link.active {
    color: var(--primary-color);
}

.nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-color);
    border-radius: 1px;
}

.nav-toggle {
    display: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-600);
    background: none;
    border: none;
}

/* 按钮样式 */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    border-radius: var(--radius-lg);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-normal);
    border: none;
    cursor: pointer;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
}

.btn-primary {
    background: var(--gradient-primary);
    color: var(--white);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-secondary {
    background: var(--gradient-secondary);
    color: var(--white);
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-success {
    background: var(--gradient-success);
    color: var(--white);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-warning {
    background: var(--gradient-warning);
    color: var(--white);
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: var(--white);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* 测试页面主要样式 */
.test-main {
    min-height: 100vh;
    padding-top: 80px;
    background: var(--gray-50);
}

/* 页面头部 */
.test-header {
    background: var(--gradient-primary);
    color: var(--white);
    padding: 3rem 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.test-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    background-size: 50px 50px;
    animation: float 30s linear infinite;
    opacity: 0.3;
}

@keyframes float {
    0% { transform: translateX(0) translateY(0); }
    100% { transform: translateX(-50px) translateY(-50px); }
}

.test-header-content {
    position: relative;
    z-index: 2;
}

.test-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 1rem;
}

.test-subtitle {
    font-size: 1.25rem;
    opacity: 0.9;
    margin-bottom: 2rem;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.test-progress {
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-full);
    height: 8px;
    max-width: 600px;
    margin: 0 auto 1rem;
    overflow: hidden;
}

.progress-bar {
    background: var(--white);
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.5s ease;
    width: 0%;
}

.progress-text {
    font-size: 0.875rem;
    opacity: 0.9;
}

/* 测试容器 */
.test-container {
    padding: 4rem 0;
}

.test-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    max-width: 900px;
    margin: 0 auto;
}

/* 问卷部分 */
.questionnaire-section {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 3rem;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--gray-100);
}

.section-header {
    text-align: center;
    margin-bottom: 3rem;
}

.section-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.section-description {
    color: var(--gray-600);
    font-size: 1.125rem;
    max-width: 600px;
    margin: 0 auto;
}

/* 问题样式 */
.question-container {
    margin-bottom: 2.5rem;
    padding: 2rem;
    background: var(--gray-50);
    border-radius: var(--radius-xl);
    border: 1px solid var(--gray-100);
    transition: var(--transition-normal);
}

.question-container:hover {
    box-shadow: var(--shadow-md);
}

.question-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: var(--gradient-primary);
    color: var(--white);
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.question-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.question-options {
    display: grid;
    gap: 0.75rem;
}

.option-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: var(--transition-normal);
    position: relative;
}

.option-item:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.option-item.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

.option-item.selected::after {
    content: '✓';
    position: absolute;
    right: 1rem;
    color: var(--primary-color);
    font-weight: 700;
}

.option-radio {
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-radius: 50%;
    position: relative;
    flex-shrink: 0;
}

.option-item.selected .option-radio {
    border-color: var(--primary-color);
    background: var(--primary-color);
}

.option-item.selected .option-radio::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: var(--white);
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

.option-text {
    color: var(--gray-700);
    font-weight: 500;
}

.option-score {
    margin-left: auto;
    font-size: 0.875rem;
    color: var(--gray-500);
    font-weight: 600;
}

/* 脑部影像上传部分 */
.upload-section {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 3rem;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--gray-100);
    margin-top: 2rem;
}

.upload-container {
    max-width: 600px;
    margin: 0 auto;
}

.upload-area {
    border: 3px dashed var(--gray-300);
    border-radius: var(--radius-xl);
    padding: 3rem 2rem;
    text-align: center;
    background: var(--gray-50);
    transition: var(--transition-normal);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}

.upload-area.has-file {
    border-color: var(--success-color);
    background: rgba(16, 185, 129, 0.05);
}

.upload-icon {
    font-size: 3rem;
    color: var(--gray-400);
    margin-bottom: 1rem;
    transition: var(--transition-normal);
}

.upload-area:hover .upload-icon,
.upload-area.dragover .upload-icon {
    color: var(--primary-color);
    transform: scale(1.1);
}

.upload-area.has-file .upload-icon {
    color: var(--success-color);
}

.upload-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.upload-hint {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin-bottom: 1.5rem;
}

.upload-button {
    background: var(--gradient-primary);
    color: var(--white);
    padding: 0.75rem 2rem;
    border-radius: var(--radius-lg);
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-normal);
}

.upload-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.file-input {
    display: none;
}

.file-info {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: var(--white);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.file-info.show {
    display: block;
}

.file-name {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.file-size {
    font-size: 0.875rem;
    color: var(--gray-500);
}

.remove-file {
    background: var(--error-color);
    color: var(--white);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: var(--transition-normal);
}

.remove-file:hover {
    background: #dc2626;
}

/* 支持的格式提示 */
.supported-formats {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.formats-title {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1rem;
}

.formats-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.format-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-600);
    font-size: 0.875rem;
}

.format-item i {
    color: var(--success-color);
}

/* 操作按钮区域 */
.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 3rem;
    padding: 2rem;
    background: var(--white);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-lg);
    flex-wrap: wrap;
}

/* 测试完成状态 */
.completion-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.status-item.completed .status-icon {
    background: var(--success-color);
    color: var(--white);
}

.status-item.pending .status-icon {
    background: var(--gray-300);
    color: var(--gray-600);
}

.status-text {
    font-weight: 600;
    color: var(--gray-900);
}

/* 加载状态 */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.loading-overlay.show {
    display: flex;
}

.loading-content {
    text-align: center;
    background: var(--white);
    padding: 3rem;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-2xl);
    max-width: 400px;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.loading-subtitle {
    font-size: 0.875rem;
    color: var(--gray-600);
}

/* 额外的问卷字段 */
.additional-fields {
    margin-top: 3rem;
    padding: 2rem;
    background: var(--gray-50);
    border-radius: var(--radius-xl);
    border: 1px solid var(--gray-100);
}

.additional-fields h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1.5rem;
}

.field-group {
    margin-bottom: 1.5rem;
}

.field-label {
    display: block;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.field-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    background: var(--white);
    font-size: 1rem;
    transition: var(--transition-normal);
}

.field-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.completion-time {
    background: var(--white);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    margin-top: 2rem;
    border: 1px solid var(--gray-200);
    text-align: center;
}

.time-display {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary-color);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .nav-menu {
        display: none;
    }
    
    .nav-toggle {
        display: block;
    }
    
    .test-main {
        padding-top: 70px;
    }
    
    .test-header {
        padding: 2rem 0;
    }
    
    .test-title {
        font-size: 2rem;
    }
    
    .test-subtitle {
        font-size: 1rem;
    }
    
    .questionnaire-section,
    .upload-section {
        padding: 2rem;
        margin: 1rem;
    }
    
    .question-container {
        padding: 1.5rem;
    }
    
    .option-item {
        padding: 0.75rem 1rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .completion-status {
        grid-template-columns: 1fr;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 1rem;
    }
    
    .test-title {
        font-size: 1.75rem;
    }
    
    .questionnaire-section,
    .upload-section {
        padding: 1.5rem;
        margin: 0.5rem;
    }
    
    .question-text {
        font-size: 1rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
    }
}

/* 动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.question-container {
    animation: fadeInUp 0.6s ease-out;
}

.option-item {
    animation: slideInRight 0.4s ease-out;
}

/* 特殊效果 */
.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-primary:hover::before {
    left: 100%;
}

/* 完成测试按钮特殊样式 */
.btn-finish {
    background: var(--gradient-warning);
    color: var(--white);
    font-weight: 700;
    position: relative;
    overflow: hidden;
}

.btn-finish:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-finish::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.btn-finish:hover::before {
    left: 100%;
}

/* 确认对话框样式 */
.confirm-dialog {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    backdrop-filter: blur(5px);
}

.confirm-dialog.show {
    display: flex;
}

.confirm-content {
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: 2.5rem;
    max-width: 400px;
    margin: 1rem;
    box-shadow: var(--shadow-2xl);
    text-align: center;
}

.confirm-icon {
    font-size: 3rem;
    color: var(--warning-color);
    margin-bottom: 1rem;
}

.confirm-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 1rem;
}

.confirm-message {
    color: var(--gray-600);
    margin-bottom: 2rem;
    line-height: 1.5;
}

.confirm-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.confirm-buttons .btn {
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
}
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-brain"></i>
                <span>MindCare</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">Home</a>
                <a href="#" class="nav-link active">Start Test</a>
                <a href="history.html" class="nav-link">History</a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="test-main">
        <!-- 测试头部 -->
        <section class="test-header">
            <div class="container">
                <div class="test-header-content">
                    <h1 class="test-title">Mental Health Assessment Test</h1>
                    <p class="test-subtitle">
                        Based on the professional Mood Disorders Questionnaire,
                        combined with AI brain imaging analysis, providing you with comprehensive mental health assessment
                    </p>
                    <div class="test-progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p class="progress-text">
                        Completion Progress: <span id="progressText">0%</span>
                    </p>
                </div>
            </div>
        </section>

        <!-- 测试内容 -->
        <section class="test-container">
            <div class="container">
                <div class="test-content">
                    <!-- 问卷部分 -->
                    <div class="questionnaire-section">
                        <div class="section-header">
                            <h2 class="section-title">Mood Disorders Questionnaire</h2>
                            <p class="section-description">
                                Please read each question carefully and select the answer that best matches your actual situation.
                                This questionnaire uses the professional MDQ scale, which helps identify possible mood disorder symptoms.
                            </p>
                        </div>

                        <form id="questionnaireForm">
                            <div id="questionsContainer">
                                <!-- Questions will be dynamically generated through JavaScript -->
                            </div>

                            <!-- 额外字段 -->
                            <div class="additional-fields">
                                <h3>Additional Information</h3>
                                <div class="field-group">
                                    <label for="coOccurrence" class="field-label">
                                        Do these symptoms occur at the same time?
                                    </label>
                                    <select id="coOccurrence" class="field-select" name="co_occurrence">
                                        <option value="">Please select</option>
                                        <option value="yes">Yes, they usually occur together</option>
                                        <option value="no">No, they usually occur separately</option>
                                        <option value="sometimes">Sometimes they occur together</option>
                                    </select>
                                </div>

                                <div class="field-group">
                                    <label for="severity" class="field-label">
                                        To what extent do these symptoms affect you?
                                    </label>
                                    <select id="severity" class="field-select" name="severity">
                                        <option value="">Please select</option>
                                        <option value="no">No problem</option>
                                        <option value="minor">Minor problem</option>
                                        <option value="moderate">Moderate problem</option>
                                        <option value="serious">Serious problem</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 完成时间显示 -->
                            <div class="completion-time">
                                <div class="time-display">
                                    Completion Time: <span id="completionTime">00:00</span>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 脑部影像上传部分 -->
                    <div class="upload-section" id="uploadSection">
                        <div class="section-header">
                            <h2 class="section-title">Brain Imaging Analysis</h2>
                            <p class="section-description">
                                Upload your brain imaging files, and our AI system will perform intelligent analysis,
                                providing you with more accurate mental health assessment results.
                            </p>
                        </div>

                        <div class="upload-container">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt" id="uploadIcon"></i>
                                </div>
                                <div class="upload-text" id="uploadText">
                                    Click to upload or drag files to this area
                                </div>
                                <div class="upload-hint">
                                    Supports NII, JPG, PNG, DICOM formats, file size should not exceed 50MB
                                </div>
                                <button type="button" class="upload-button" id="uploadButton">
                                    <i class="fas fa-plus"></i>
                                    Select File
                                </button>
                                <input type="file" id="fileInput" class="file-input" accept=".nii,.nii.gz,.jpg,.jpeg,.png,.dcm,.dicom" multiple>
                            </div>

                            <div class="file-info" id="fileInfo">
                                <div class="file-name" id="fileName"></div>
                                <div class="file-size" id="fileSize"></div>
                                <button type="button" class="remove-file" id="removeFile">
                                    <i class="fas fa-trash"></i>
                                    Remove File
                                </button>
                            </div>

                            <div class="supported-formats">
                                <h4 class="formats-title">Supported file formats:</h4>
                                <div class="formats-list">
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>NII / NII.GZ (Neuroimaging)</span>
                                    </div>
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>DICOM (Medical Imaging)</span>
                                    </div>
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>JPG / JPEG (Image)</span>
                                    </div>
                                    <div class="format-item">
                                        <i class="fas fa-check"></i>
                                        <span>PNG (Image)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 测试完成状态 -->
                    <div class="completion-status" id="completionStatus">
                        <div class="status-item" id="questionnaireStatus">
                            <div class="status-icon pending">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="status-text">Questionnaire Assessment</div>
                        </div>
                        <div class="status-item" id="uploadStatus">
                            <div class="status-icon pending">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="status-text">Image Upload</div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="action-buttons">
                        <button type="button" class="btn btn-outline" id="saveProgress">
                            <i class="fas fa-save"></i>
                            Save Progress
                        </button>
                        <button type="button" class="btn btn-secondary" id="previewResults">
                            <i class="fas fa-eye"></i>
                            Preview Results
                        </button>
                        <button type="button" class="btn btn-finish" id="finishTest">
                            <i class="fas fa-home"></i>
                            Finish Test
                        </button>
                        <button type="button" class="btn btn-success" id="generateReport" disabled>
                            <i class="fas fa-file-alt"></i>
                            Generate AI Report
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Processing...</div>
            <div class="loading-subtitle" id="loadingSubtitle">Please wait, do not close the page</div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="confirm-title">Confirm Finish Test</h3>
            <p class="confirm-message">
                Finishing the test will clear the current progress and return to the homepage.
                If you wish to save the test results, please click the "Generate AI Report" button first.
                Are you sure you want to finish the test?
            </p>
            <div class="confirm-buttons">
                <button type="button" class="btn btn-outline" id="cancelFinish">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-warning" id="confirmFinish">
                    <i class="fas fa-check"></i>
                    Confirm Finish
                </button>
            </div>
        </div>
    </div>

    <script>
// API配置
const API_BASE_URL = '/api';

// 工具函数库
const Utils = {
    // 节流函数
    throttle: function(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    },

    // 防抖函数
    debounce: function(func, delay) {
        let timeoutId;
        return function() {
            const args = arguments;
            const context = this;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(context, args), delay);
        }
    },

    // 格式化文件大小
    formatFileSize: function(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    // 生成随机ID
    generateId: function(length = 8) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    },

    // 获取当前时间戳
    getCurrentTimestamp: function() {
        return new Date().toISOString();
    },

    // 格式化时间
    formatTime: function(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
};

// API请求封装
const API = {
    // 基础请求方法
    async request(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const config = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include', // 包含cookies用于会话管理
            ...options
        };

        try {
            const response = await fetch(url, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || '请求失败');
            }
            
            return data;
        } catch (error) {
            console.error(`API请求失败 [${endpoint}]:`, error);
            throw error;
        }
    },

    // GET请求
    async get(endpoint) {
        return this.request(endpoint, { method: 'GET' });
    },

    // POST请求
    async post(endpoint, data) {
        return this.request(endpoint, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    },

    // 文件上传
    async uploadFiles(files) {
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('files', file);
        });

        const url = `${API_BASE_URL}/test/upload`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || '文件上传失败');
            }
            
            return data;
        } catch (error) {
            console.error('文件上传失败:', error);
            throw error;
        }
    },

    // 保存MDQ测试结果
    async saveMDQTest(testData) {
        return this.post('/test/mdq', testData);
    },

    // 获取测试历史
    async getTestHistory(limit = 10) {
        return this.get(`/test/history?limit=${limit}`);
    },

    // 获取用户资料
    async getUserProfile() {
        return this.get('/user/profile');
    },

    // 检查用户登录状态
    async checkLoginStatus() {
        try {
            const profile = await this.getUserProfile();
            return { loggedIn: true, profile };
        } catch (error) {
            return { loggedIn: false, error: error.message };
        }
    },

    // 清空测试进度
    async clearTestProgress() {
        return this.post('/test/clear-progress', {});
    }
};

// 消息提示组件
const Toast = {
    container: null,

    init: function() {
        if (!this.container) {
            this.container = document.createElement('div');
            this.container.id = 'toastContainer';
            this.container.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                z-index: 10001;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                pointer-events: none;
            `;
            document.body.appendChild(this.container);
        }
    },

    show: function(message, type = 'info', duration = 3000) {
        this.init();

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            padding: 1rem 1.5rem;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            min-width: 250px;
            font-weight: 500;
        `;

        // 设置不同类型的样式
        if (type === 'success') {
            toast.style.borderLeft = '4px solid var(--success-color)';
            toast.style.color = 'var(--success-color)';
        } else if (type === 'error') {
            toast.style.borderLeft = '4px solid var(--error-color)';
            toast.style.color = 'var(--error-color)';
        } else if (type === 'warning') {
            toast.style.borderLeft = '4px solid var(--warning-color)';
            toast.style.color = 'var(--warning-color)';
        } else {
            toast.style.borderLeft = '4px solid var(--primary-color)';
            toast.style.color = 'var(--primary-color)';
        }

        this.container.appendChild(toast);

        // 显示动画
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 10);

        // 自动隐藏
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (this.container.contains(toast)) {
                    this.container.removeChild(toast);
                }
            }, 300);
        }, duration);
    },

    success: function(message, duration) {
        this.show(message, 'success', duration);
    },

    error: function(message, duration) {
        this.show(message, 'error', duration);
    },

    warning: function(message, duration) {
        this.show(message, 'warning', duration);
    },

    info: function(message, duration) {
        this.show(message, 'info', duration);
    }
};

// MDQ Questionnaire Data
const MDQQuestions = [
    {
        id: 1,
        text: "Have you ever had a period when you felt unusually elevated, excited, or overactive?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 2,
        text: "During that state, did you feel more confident or arrogant than usual?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 3,
        text: "Have you ever had a significantly reduced need for sleep yet still felt energetic?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 4,
        text: "Have you been more talkative than usual or spoken faster?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 5,
        text: "Have your thoughts ever raced rapidly, making it difficult to concentrate?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 6,
        text: "Have you been particularly easily distracted, with difficulty sustaining attention?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 7,
        text: "Have you felt more energetic and motivated than usual?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 8,
        text: "Have you been more social or outgoing than usual?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 9,
        text: "Have you had a stronger interest in sex than usual?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 10,
        text: "Have you made unusual or impulsive decisions?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 11,
        text: "Have you spent money more impulsively or irrationally than usual?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 12,
        text: "Have these behavioral changes caused problems in your work, studies, or relationships?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    },
    {
        id: 13,
        text: "Have family, friends, or doctors noticed these behavioral changes in you?",
        options: [
            { text: "Never", value: "no" },
            { text: "Rarely", value: "rarely" },
            { text: "Sometimes", value: "sometimes" },
            { text: "Often", value: "often" },
            { text: "Always", value: "always" }
        ]
    }
];

// Test Manager
class TestManager {
    constructor() {
        this.answers = {};
        this.uploadedFiles = [];
        this.currentProgress = 0;
        this.isQuestionnaireComplete = false;
        this.isUploadComplete = false;
        this.startTime = Date.now();
        this.timeInterval = null;
        this.isLoggedIn = false;
        this.userProfile = null;
        this.init();
    }

    async init() {
        // 检查登录状态
        await this.checkLoginStatus();
        
        this.renderQuestions();
        this.setupEventListeners();
        this.setupFileUpload();
        this.startTimer();
        this.updateProgress();
        this.loadSavedProgress();
    }

    // Check login status
    async checkLoginStatus() {
        try {
            const status = await API.checkLoginStatus();
            this.isLoggedIn = status.loggedIn;
            this.userProfile = status.profile;

            if (!this.isLoggedIn) {
                Toast.warning('Please log in first to save test results', 5000);
                // Can optionally redirect to login page
                // window.location.href = 'login.html';
            } else {
                Toast.success(`Welcome, ${this.userProfile.username}!`, 2000);
            }
        } catch (error) {
            console.error('Failed to check login status:', error);
            Toast.error('Unable to verify login status');
        }
    }

    // Start timer
    startTimer() {
        this.timeInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            const timeDisplay = document.getElementById('completionTime');
            if (timeDisplay) {
                timeDisplay.textContent = Utils.formatTime(elapsed);
            }
        }, 1000);
    }

    // Stop timer
    stopTimer() {
        if (this.timeInterval) {
            clearInterval(this.timeInterval);
            this.timeInterval = null;
        }
    }

    // Get completion time (in seconds)
    getCompletionTime() {
        return Math.floor((Date.now() - this.startTime) / 1000);
    }

    // Render questions
    renderQuestions() {
        const container = document.getElementById('questionsContainer');
        if (!container) return;

        container.innerHTML = MDQQuestions.map((question, index) => `
            <div class="question-container" data-question-id="${question.id}">
                <div class="question-number">${question.id}</div>
                <div class="question-text">${question.text}</div>
                <div class="question-options">
                    ${question.options.map((option, optionIndex) => `
                        <div class="option-item" data-value="${option.value}" data-question="${question.id}">
                            <div class="option-radio"></div>
                            <div class="option-text">${option.text}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');

        // Add animation delay
        const questions = container.querySelectorAll('.question-container');
        questions.forEach((question, index) => {
            question.style.animationDelay = `${index * 0.1}s`;
        });
    }

    // Setup event listeners
    setupEventListeners() {
        // Questionnaire option click
        document.addEventListener('click', (e) => {
            if (e.target.closest('.option-item')) {
                this.handleOptionClick(e.target.closest('.option-item'));
            }
        });

        // Button events
        document.getElementById('saveProgress')?.addEventListener('click', () => {
            this.saveProgress();
        });

        document.getElementById('previewResults')?.addEventListener('click', () => {
            this.previewResults();
        });

        document.getElementById('generateReport')?.addEventListener('click', () => {
            this.generateAndViewReport();
        });

        // Finish test button event
        document.getElementById('finishTest')?.addEventListener('click', () => {
            this.showFinishConfirmDialog();
        });

        // Confirmation dialog events
        document.getElementById('cancelFinish')?.addEventListener('click', () => {
            this.hideFinishConfirmDialog();
        });

        document.getElementById('confirmFinish')?.addEventListener('click', () => {
            this.finishTest();
        });

        // Mobile navigation
        const navToggle = document.getElementById('navToggle');
        if (navToggle) {
            navToggle.addEventListener('click', () => {
                const navMenu = document.querySelector('.nav-menu');
                navMenu.classList.toggle('active');
            });
        }
    }

    // Show finish test confirmation dialog
    showFinishConfirmDialog() {
        const dialog = document.getElementById('confirmDialog');
        if (dialog) {
            dialog.classList.add('show');
        }
    }

    // Hide finish test confirmation dialog
    hideFinishConfirmDialog() {
        const dialog = document.getElementById('confirmDialog');
        if (dialog) {
            dialog.classList.remove('show');
        }
    }

    // Finish test and return to homepage
    async finishTest() {
        this.hideFinishConfirmDialog();
        this.showLoading('Clearing test progress...', 'Returning to homepage');

        try {
            // Stop timer
            this.stopTimer();

            // Clear locally stored progress
            localStorage.removeItem('testProgress');
            localStorage.removeItem('currentTestData');

            // If logged in, call backend API to clear progress
            if (this.isLoggedIn) {
                try {
                    await API.clearTestProgress();
                    console.log('✅ Server-side test progress cleared');
                } catch (error) {
                    console.warn('⚠️ Failed to clear server-side progress, but continuing:', error.message);
                }
            }

            // Clear current instance data
            this.answers = {};
            this.uploadedFiles = [];
            this.currentProgress = 0;
            this.isQuestionnaireComplete = false;
            this.isUploadComplete = false;

            this.hideLoading();

            // Show success message
            Toast.success('Test completed, returning to homepage...', 2000);

            // Delay redirect to show message
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500);

        } catch (error) {
            this.hideLoading();
            console.error('Failed to finish test:', error);
            Toast.error('An error occurred while finishing the test, but will still return to homepage');

            // Redirect even if error occurs
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);
        }
    }

    // Handle option click
    handleOptionClick(optionElement) {
        const questionId = parseInt(optionElement.dataset.question);
        const value = optionElement.dataset.value;

        // Remove selected state from other options in the same group
        const questionContainer = optionElement.closest('.question-container');
        questionContainer.querySelectorAll('.option-item').forEach(item => {
            item.classList.remove('selected');
        });

        // Set current option as selected
        optionElement.classList.add('selected');

        // Save answer
        this.answers[`q${questionId}`] = value;

        // Add selection animation
        optionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            optionElement.style.transform = '';
        }, 150);

        // Update progress
        this.updateProgress();

        Toast.success(`Question ${questionId} answered`, 1000);
    }

    // Setup file upload
    setupFileUpload() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const removeButton = document.getElementById('removeFile');

        // Click upload area
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Click upload button
        uploadButton.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        // File selection
        fileInput.addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files);
        });

        // Drag and drop upload
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            this.handleFileSelect(e.dataTransfer.files);
        });

        // Remove file
        removeButton.addEventListener('click', () => {
            this.removeFiles();
        });
    }

    // Handle file selection
    handleFileSelect(files) {
        if (files.length === 0) return;

        const validFiles = [];
        const maxSize = 50 * 1024 * 1024; // 50MB
        const validExtensions = ['.nii', '.nii.gz', '.jpg', '.jpeg', '.png', '.dcm', '.dicom'];

        Array.from(files).forEach(file => {
            // Check file size
            if (file.size > maxSize) {
                Toast.error(`File ${file.name} exceeds 50MB limit`);
                return;
            }

            // Check file type
            const fileName = file.name.toLowerCase();
            const isValidType = validExtensions.some(ext => fileName.endsWith(ext));

            if (!isValidType) {
                Toast.error(`File ${file.name} format not supported`);
                return;
            }

            validFiles.push(file);
        });

        if (validFiles.length > 0) {
            this.uploadedFiles = validFiles;
            this.updateFileDisplay();
            this.updateProgress();
            Toast.success(`Successfully selected ${validFiles.length} file(s)`);
        }
    }

    // Update file display
    updateFileDisplay() {
        const uploadArea = document.getElementById('uploadArea');
        const uploadIcon = document.getElementById('uploadIcon');
        const uploadText = document.getElementById('uploadText');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        if (this.uploadedFiles.length > 0) {
            uploadArea.classList.add('has-file');
            uploadIcon.className = 'fas fa-check-circle';

            if (this.uploadedFiles.length === 1) {
                const file = this.uploadedFiles[0];
                uploadText.textContent = 'File uploaded successfully';
                fileName.textContent = file.name;
                fileSize.textContent = Utils.formatFileSize(file.size);
            } else {
                uploadText.textContent = 'Multiple files uploaded successfully';
                fileName.textContent = `${this.uploadedFiles.length} files`;
                const totalSize = this.uploadedFiles.reduce((sum, file) => sum + file.size, 0);
                fileSize.textContent = Utils.formatFileSize(totalSize);
            }

            fileInfo.classList.add('show');
        } else {
            uploadArea.classList.remove('has-file');
            uploadIcon.className = 'fas fa-cloud-upload-alt';
            uploadText.textContent = 'Click to upload or drag files to this area';
            fileInfo.classList.remove('show');
        }
    }

    // Remove files
    removeFiles() {
        this.uploadedFiles = [];
        this.updateFileDisplay();
        this.updateProgress();
        document.getElementById('fileInput').value = '';
        Toast.info('All files removed');
    }

    // Update progress
    updateProgress() {
        const totalQuestions = MDQQuestions.length;
        const answeredQuestions = Object.keys(this.answers).length;
        const questionnaireProgress = (answeredQuestions / totalQuestions) * 70; // Questionnaire 70%
        const uploadProgress = this.uploadedFiles.length > 0 ? 30 : 0; // Upload 30%

        this.currentProgress = questionnaireProgress + uploadProgress;
        this.isQuestionnaireComplete = answeredQuestions === totalQuestions;
        this.isUploadComplete = this.uploadedFiles.length > 0;

        // Update progress bar
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        if (progressBar) {
            progressBar.style.width = `${this.currentProgress}%`;
        }

        if (progressText) {
            progressText.textContent = `${Math.round(this.currentProgress)}%`;
        }

        // Update status indicators
        this.updateStatusIndicators();

        // Update generate report button state
        this.updateGenerateButton();
    }

    // Update status indicators
    updateStatusIndicators() {
        const questionnaireStatus = document.getElementById('questionnaireStatus');
        const uploadStatus = document.getElementById('uploadStatus');

        if (questionnaireStatus) {
            const icon = questionnaireStatus.querySelector('.status-icon');
            if (this.isQuestionnaireComplete) {
                icon.classList.remove('pending');
                icon.classList.add('completed');
            } else {
                icon.classList.remove('completed');
                icon.classList.add('pending');
            }
        }

        if (uploadStatus) {
            const icon = uploadStatus.querySelector('.status-icon');
            if (this.isUploadComplete) {
                icon.classList.remove('pending');
                icon.classList.add('completed');
            } else {
                icon.classList.remove('completed');
                icon.classList.add('pending');
            }
        }
    }

    // Update generate report button
    updateGenerateButton() {
        const generateButton = document.getElementById('generateReport');
        if (generateButton) {
            // **Fix: Lower button activation threshold**
            // Report can be generated with partial questions (at least 7) or uploaded images
            const answeredQuestions = Object.keys(this.answers).length;
            const hasMinimumData = answeredQuestions >= 7 || this.isUploadComplete;

            // If all questions completed, button shows green (fully enabled)
            // If only partial questions completed, button shows yellow (partially enabled)
            const isFullyComplete = this.isQuestionnaireComplete || (answeredQuestions >= 10 && this.isUploadComplete);

            generateButton.disabled = !hasMinimumData;

            if (hasMinimumData) {
                generateButton.style.opacity = '1';
                generateButton.style.cursor = 'pointer';

                // Adjust button style based on completion
                if (isFullyComplete) {
                    generateButton.classList.remove('btn-warning');
                    generateButton.classList.add('btn-success');
                    generateButton.title = 'Sufficient data, can generate complete report';
                } else {
                    generateButton.classList.remove('btn-success');
                    generateButton.classList.add('btn-warning');
                    generateButton.title = `${answeredQuestions}/13 questions answered, recommend completing more for accurate report`;
                }
            } else {
                generateButton.style.opacity = '0.6';
                generateButton.style.cursor = 'not-allowed';
                generateButton.title = 'Please complete at least 7 questions or upload brain images';
            }

            console.log(`Generate report button status: ${answeredQuestions} questions answered, ${this.uploadedFiles.length} files uploaded, button ${hasMinimumData ? 'enabled' : 'disabled'}`);
        }
    }

    // Save progress to localStorage
    saveProgress() {
        if (!this.isLoggedIn) {
            Toast.warning('Please log in first to save progress to server');
        }

        const progressData = {
            answers: this.answers,
            uploadedFileNames: this.uploadedFiles.map(f => f.name),
            additionalFields: this.getAdditionalFields(),
            timestamp: Utils.getCurrentTimestamp(),
            progress: this.currentProgress,
            completionTime: this.getCompletionTime()
        };

        try {
            // Save to local storage
            localStorage.setItem('testProgress', JSON.stringify(progressData));
            Toast.success('Progress saved locally');

            // If logged in, also save to server
            if (this.isLoggedIn) {
                this.saveProgressToServer(progressData);
            }
        } catch (error) {
            console.error('Failed to save progress:', error);
            Toast.error('Save failed, please try again');
        }
    }

    // Save progress to server
    async saveProgressToServer(progressData) {
        try {
            // API call to save progress to server can be added here
            // const result = await API.post('/test/save-progress', progressData);
            // Toast.success('Progress synced to server');
            console.log('Progress data ready to save to server:', progressData);
        } catch (error) {
            console.error('Failed to save progress to server:', error);
            Toast.warning('Unable to sync to server, saved locally');
        }
    }

    // Get additional fields values
    getAdditionalFields() {
        return {
            co_occurrence: document.getElementById('coOccurrence')?.value || '',
            severity: document.getElementById('severity')?.value || ''
        };
    }

    // Load saved progress
    loadSavedProgress() {
        try {
            const savedData = localStorage.getItem('testProgress');
            if (savedData) {
                const progressData = JSON.parse(savedData);
                this.answers = progressData.answers || {};

                // Restore additional fields
                if (progressData.additionalFields) {
                    const { co_occurrence, severity } = progressData.additionalFields;
                    if (co_occurrence) {
                        const coSelect = document.getElementById('coOccurrence');
                        if (coSelect) coSelect.value = co_occurrence;
                    }
                    if (severity) {
                        const severitySelect = document.getElementById('severity');
                        if (severitySelect) severitySelect.value = severity;
                    }
                }

                // Restore questionnaire selection state
                Object.entries(this.answers).forEach(([questionKey, value]) => {
                    const questionId = questionKey.replace('q', '');
                    const optionElement = document.querySelector(
                        `.option-item[data-question="${questionId}"][data-value="${value}"]`
                    );
                    if (optionElement) {
                        optionElement.classList.add('selected');
                    }
                });

                this.updateProgress();

                if (Object.keys(this.answers).length > 0) {
                    Toast.info('Previous test progress restored');
                }
            }
        } catch (error) {
            console.error('Failed to load progress:', error);
        }
    }

    // Preview results
    previewResults() {
        if (Object.keys(this.answers).length === 0 && this.uploadedFiles.length === 0) {
            Toast.warning('Please complete questionnaire or upload brain images first');
            return;
        }

        this.showLoading('Analyzing data...', 'Generating preview results');

        // Simulate analysis process
        setTimeout(() => {
            this.hideLoading();

            const answeredQuestions = Object.keys(this.answers).length;
            const totalQuestions = MDQQuestions.length;
            const completionPercentage = Math.round((answeredQuestions / totalQuestions) * 100);

            let resultMessage = '';
            if (answeredQuestions === 0) {
                resultMessage = 'Please complete the questionnaire for a more accurate assessment.';
            } else if (answeredQuestions < totalQuestions) {
                resultMessage = `Completed ${answeredQuestions}/${totalQuestions} questions (${completionPercentage}%). Recommend completing all questions for a more accurate assessment.`;
            } else {
                // Simple scoring logic (should be more complex in real application)
                const positiveAnswers = Object.values(this.answers).filter(
                    answer => ['often', 'always', 'sometimes'].includes(answer)
                ).length;

                if (positiveAnswers <= 4) {
                    resultMessage = 'Preliminary assessment shows good mood state. Please continue maintaining a healthy lifestyle.';
                } else if (positiveAnswers <= 8) {
                    resultMessage = 'Preliminary assessment shows possible mild mood fluctuations. Recommend paying attention to mental health.';
                } else if (positiveAnswers <= 10) {
                    resultMessage = 'Preliminary assessment shows possible moderate mood issues. Recommend seeking professional advice.';
                } else {
                    resultMessage = 'Preliminary assessment shows possible serious mood issues. Strongly recommend consulting a professional doctor.';
                }
            }

            const uploadMessage = this.uploadedFiles.length > 0
                ? `Uploaded ${this.uploadedFiles.length} brain imaging file(s).`
                : 'No brain imaging files uploaded.';

            Toast.success(`Preview Results: ${resultMessage} ${uploadMessage}`, 8000);
        }, 2000);
    }

    // Generate and view report (simplified version, direct redirect)
    // Fix: Update generateAndViewReport method to properly handle analysis results
    async generateAndViewReport() {
        if (!this.isQuestionnaireComplete && !this.isUploadComplete) {
            Toast.warning('Please complete at least the questionnaire or upload brain images');
            return;
        }

        if (!this.isLoggedIn) {
            Toast.error('Please log in first to save test results');
            return;
        }

        this.showLoading('Saving test results...', 'Preparing to generate AI analysis report');

        try {
            // Stop timer
            this.stopTimer();
            const completionTime = this.getCompletionTime();

            // Prepare test data to save
            const testData = {
                answers: this.answers,
                co_occurrence: document.getElementById('coOccurrence')?.value || 'no',
                severity: document.getElementById('severity')?.value || 'no',
                completion_time: completionTime
            };

            // Save MDQ test results to database
            console.log('Preparing to save test data:', testData);
            const result = await API.saveMDQTest(testData);

            if (result.success) {
                Toast.success('Test results saved, redirecting to AI report page...');

                // **Fix: Save complete test data including all analysis results**
                const fullTestData = {
                    testId: result.test_id,
                    timestamp: Utils.getCurrentTimestamp(),
                    answers: this.answers,
                    additionalFields: this.getAdditionalFields(),
                    uploadedFiles: this.uploadedFiles.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    })),
                    completionTime: completionTime,

                    // **New: Save all analysis data returned from server**
                    score_result: result.score_result || null,
                    analysis_data: result.analysis_data || null,
                    ai_analysis_data: result.ai_analysis_data || null,
                    analysis: result.analysis || null,
                    analysis_id: result.analysis_id || null,

                    serverSaved: true
                };

                // Save to history
                this.saveToHistory(fullTestData);

                // **New: Also save detailed analysis data to sessionStorage for report page**
                sessionStorage.setItem('lastTestResult', JSON.stringify({
                    testId: result.test_id,
                    analysisId: result.analysis_id,
                    fullData: fullTestData
                }));

                // Clear progress cache
                localStorage.removeItem('testProgress');

                this.hideLoading();

                // Build report URL with all necessary parameters
                let reportUrl = `report.html?testId=${result.test_id}`;
                if (result.analysis_id) {
                    reportUrl += `&analysisId=${result.analysis_id}`;
                }

                // **Add timestamp parameter to ensure page refresh**
                reportUrl += `&timestamp=${Date.now()}`;

                console.log('Redirecting to report page:', reportUrl);
                window.location.href = reportUrl;

            } else {
                throw new Error(result.message || 'Save failed');
            }

        } catch (error) {
            this.hideLoading();
            console.error('Failed to save test results:', error);

            if (error.message.includes('请先登录')) {
                Toast.error('Session expired, please log in again');
            } else {
                Toast.error(`Save failed: ${error.message}`);

                // Offer local save option
                this.offerLocalSave();
            }
        }
    }

    // **New: Dedicated debugging method to view saved test results**
    debugTestResult() {
        const lastResult = sessionStorage.getItem('lastTestResult');
        if (lastResult) {
            console.log('Last saved test result:', JSON.parse(lastResult));
        } else {
            console.log('No last saved test result found');
        }

        const history = localStorage.getItem('testHistory');
        if (history) {
            console.log('Local test history:', JSON.parse(history));
        } else {
            console.log('No local test history');
        }
    }


    // Upload files to server
    async uploadFilesToServer() {
        if (this.uploadedFiles.length === 0) {
            return { success: true, message: 'No files to upload' };
        }

        if (!this.isLoggedIn) {
            throw new Error('Please log in first to upload files');
        }

        try {
            const result = await API.uploadFiles(this.uploadedFiles);
            Toast.success(`Successfully uploaded ${this.uploadedFiles.length} file(s)`);
            return result;
        } catch (error) {
            console.error('File upload failed:', error);
            Toast.error(`File upload failed: ${error.message}`);
            throw error;
        }
    }

    // Save to local history
    saveToHistory(testData) {
        try {
            const existingHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');

            // **Ensure complete data structure is saved**
            const historyEntry = {
                ...testData,
                localSaveTime: Utils.getCurrentTimestamp(),
                version: '1.1',  // Version number for data migration

                // **New: Ensure required fields exist**
                test_id: testData.testId || testData.test_id || Utils.generateId(12),
                test_date: testData.timestamp || Utils.getCurrentTimestamp(),
                test_timestamp: testData.timestamp || Utils.getCurrentTimestamp(),
                completion_status: 'completed',  // Mark as completed
                total_score: testData.total_score || 0,
                completed_questions: testData.completed_questions || Object.keys(testData.answers || {}).length
            };

            existingHistory.unshift(historyEntry);

            // Keep only last 10 tests
            if (existingHistory.length > 10) {
                existingHistory.splice(10);
            }

            localStorage.setItem('testHistory', JSON.stringify(existingHistory));
            console.log('✅ Test results saved to local history, including analysis data');

            // **Debug: Output saved data**
            console.log('Saved history data:', historyEntry);
            console.log(`Current local history total: ${existingHistory.length}`);

        } catch (error) {
            console.error('❌ Failed to save to local history:', error);
        }
    }

    // Offer local save option
    offerLocalSave() {
        const testData = {
            id: Utils.generateId(12),
            timestamp: Utils.getCurrentTimestamp(),
            answers: this.answers,
            additionalFields: this.getAdditionalFields(),
            uploadedFiles: this.uploadedFiles.map(file => ({
                name: file.name,
                size: file.size,
                type: file.type
            })),
            completionTime: this.getCompletionTime(),
            serverSaved: false
        };

        this.saveToHistory(testData);

        Toast.warning('Saved locally, can retry uploading to server later', 5000);
    }

    // Show loading state
    showLoading(text, subtitle) {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtitle = document.getElementById('loadingSubtitle');

        if (overlay) {
            overlay.classList.add('show');
            if (loadingText) loadingText.textContent = text;
            if (loadingSubtitle) loadingSubtitle.textContent = subtitle;
        }
    }

    // Hide loading state
    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
    }

    // Validate questionnaire completeness
    validateQuestionnaire() {
        const requiredFields = [
            { id: 'coOccurrence', name: 'Symptom Co-occurrence' },
            { id: 'severity', name: 'Impact Level' }
        ];

        for (const field of requiredFields) {
            const element = document.getElementById(field.id);
            if (!element || !element.value) {
                Toast.warning(`Please select "${field.name}"`);
                element?.focus();
                return false;
            }
        }

        return true;
    }

    // Cleanup resources
    cleanup() {
        this.stopTimer();

        // Remove event listeners
        window.removeEventListener('beforeunload', this.beforeUnloadHandler);
    }

    // Handle before page unload
    beforeUnloadHandler = (e) => {
        if (Object.keys(this.answers).length > 0 || this.uploadedFiles.length > 0) {
            e.preventDefault();
            e.returnValue = 'Your test progress may be lost, are you sure you want to leave?';

            // Auto-save progress
            this.saveProgress();
        }
    }
}

// Initialize after page load
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Check if mobile device
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            document.body.classList.add('mobile');
        }

        // Initialize test manager
        const testManager = new TestManager();

        // Bind instance to global for debugging
        window.testManager = testManager;

        // Add reminder before page unload
        window.addEventListener('beforeunload', testManager.beforeUnloadHandler);

        // Add page visibility change listener (auto-save when user switches tabs)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && testManager) {
                testManager.saveProgress();
            }
        });

        console.log('Test page initialization complete');

    } catch (error) {
        console.error('Test page initialization failed:', error);
        Toast.error('Page initialization failed, please refresh and try again');
    }
});

// Handle page errors
window.addEventListener('error', (e) => {
    console.error('Page error:', e.error);
    Toast.error('Page error occurred, please refresh and try again');
});

// Handle unhandled Promise rejections
window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled Promise rejection:', e.reason);
    Toast.error('Network request failed, please check network connection');
});

// Performance monitoring
window.addEventListener('load', () => {
    const loadTime = performance.now();
    console.log(`Page load time: ${Math.round(loadTime)}ms`);

    // Notify if load time is too long
    if (loadTime > 3000) {
        Toast.info('Page loading slowly, recommend checking network connection');
    }
});

// Add keyboard shortcut support
document.addEventListener('keydown', (e) => {
    // Ctrl+S to save progress
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if (window.testManager) {
            window.testManager.saveProgress();
        }
    }

    // Ctrl+Enter to generate report
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        if (window.testManager) {
            window.testManager.generateAndViewReport();
        }
    }

    // Escape to close confirmation dialog
    if (e.key === 'Escape') {
        if (window.testManager) {
            window.testManager.hideFinishConfirmDialog();
        }
    }
});
    </script>
</body>
</html>